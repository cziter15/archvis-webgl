<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Reduce aggressive caching during development / debugging on mobile devices -->
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>ArchVis WebGL</title>
	<link rel="icon" href="./cog.svg" type="image/svg+xml">
	<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();class fe{static architectureToXML(e){let n=`<?xml version="1.0" encoding="UTF-8"?>
`;n+=`<arch>
`;const i=[];return i.push(`name="${e.root.name}"`),i.push(`pos="${e.root.pos.join(",")}"`),e.root.id&&i.push(`id="${e.root.id}"`),e.root.category?i.push(`category="${e.root.category}"`):e.root.color&&i.push(`color="${e.root.color}"`),e.root.scale!==void 0&&i.push(`scale="${e.root.scale}"`),n+=`  <node ${i.join(" ")}>
`,e.root.children.forEach(o=>{n+=this.nodeToXML(o,2)}),n+=`  </node>
`,e.legend&&e.legend.length>0&&(n+=`  <legend>
`,e.legend.forEach(o=>{n+=`    <entry id="${o.id||""}" name="${o.name}" color="${o.color}" />
`}),n+=`  </legend>
`),e.uiInfo&&e.uiInfo.title&&(n+=`  <ui-info>
`,n+=`    <title>${e.uiInfo.title}</title>
`,n+=`  </ui-info>
`),n+="</arch>",n}static nodeToXML(e,n){let i="";const o=" ".repeat(n),r=[];return r.push(`name="${e.name}"`),r.push(`pos="${e.pos.join(",")}"`),e.id&&r.push(`id="${e.id}"`),e.category?r.push(`category="${e.category}"`):e.color&&r.push(`color="${e.color}"`),e.scale!==void 0&&r.push(`scale="${e.scale}"`),i+=`${o}<node ${r.join(" ")}`,e.children&&e.children.length>0?(i+=`>
`,e.children.forEach(s=>{i+=this.nodeToXML(s,n+2)}),i+=`${o}</node>
`):i+=` />
`,i}static xmlToArchitecture(e){const i=new DOMParser().parseFromString(e,"text/xml"),o=i.querySelector("arch > node");if(!o)throw new Error("Root element not found in XML");const r={id:o.getAttribute("id")||Math.random().toString(36).slice(2,9),name:o.getAttribute("name"),pos:o.getAttribute("pos").split(",").map(Number),children:[]},s=o.getAttribute("category");if(s)r.category=s;else{const E=o.getAttribute("color");E&&(r.color=E)}const a=o.getAttribute("scale");a&&(r.scale=parseFloat(a)),o.querySelectorAll(":scope > node").forEach(E=>{const w=this.parseNode(E);r.children.push(w)});const l=[],u=i.querySelector("arch > legend");u&&u.querySelectorAll("entry").forEach(w=>{const x={id:w.getAttribute("id")||Math.random().toString(36).slice(2,9),name:w.getAttribute("name"),color:w.getAttribute("color")};l.push(x)});const p={title:""},m=i.querySelector("arch > ui-info");if(m){const E=m.querySelector("title");E&&(p.title=E.textContent||"")}return{root:r,legend:l,uiInfo:p}}static parseNode(e){const n={id:e.getAttribute("id")||Math.random().toString(36).slice(2,9),name:e.getAttribute("name"),pos:e.getAttribute("pos").split(",").map(Number),children:[]},i=e.getAttribute("scale");i&&(n.scale=parseFloat(i));const o=e.getAttribute("category");if(o)n.category=o;else{const s=e.getAttribute("color");s&&(n.color=s)}return e.querySelectorAll(":scope > node").forEach(s=>{const a=this.parseNode(s);n.children.push(a)}),n}}class le{constructor(e=null){e?this.architecture=e:this.architecture={root:{name:"Empty Architecture",pos:[0,0,0],color:"#666666",scale:1,children:[]},legend:[],uiInfo:{title:""}}}get(){return this.architecture}set(e){this.architecture=e}assignIdsRecursively(e){e&&(e.id||(e.id=Math.random().toString(36).slice(2,9)),e.children&&e.children.forEach(n=>this.assignIdsRecursively(n)))}findNodeById(e,n){if(!e)return null;if(e.id&&e.id===n)return e;if(e.children)for(const i of e.children){const o=this.findNodeById(i,n);if(o)return o}return null}mapColorsToLegend(e,n){if(e){if(!e.category&&e.color&&n&&n.length){const i=n.find(o=>o.color&&o.color.toLowerCase()===e.color.toLowerCase());i&&(e.category=i.id,delete e.color)}e.children&&e.children.forEach(i=>this.mapColorsToLegend(i,n))}}renameNodeById(e,n,i){if(!e)return!1;if(e.id&&e.id===n)return e.name=i,!0;if(e.children){for(const o of e.children)if(this.renameNodeById(o,n,i))return!0}return!1}deleteNodeById(e,n){if(!e||!e.children)return!1;const i=e.children.findIndex(o=>o.id===n);if(i!==-1)return e.children.splice(i,1),!0;for(const o of e.children)if(this.deleteNodeById(o,n))return!0;return!1}}function j(t,e){return new le().findNodeById(t,e)}function me(t){return new le().assignIdsRecursively(t)}function we(t,e){return new le().mapColorsToLegend(t,e)}function ze(t,e){return new le().deleteNodeById(t,e)}class Ge{constructor({mountElement:e,colorResolver:n=null,width:i=window.innerWidth,height:o=window.innerHeight}={}){this.mountElement=e||document.getElementById("canvas"),this.colorResolver=n||(()=>"#666666"),this.scene=new THREE.Scene,this.scene.fog=new THREE.FogExp2(1296,.008),this.camera=new THREE.PerspectiveCamera(60,i/o,.1,1e3),this.camera.position.set(0,15,50),this.camera.lookAt(0,0,0),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(i,o),this.renderer.setClearColor(1296),this.mountElement&&this.mountElement.appendChild(this.renderer.domElement);const r=new THREE.AmbientLight(1710654,.8);this.scene.add(r);const s=new THREE.PointLight(65535,1.5,60);s.position.set(15,15,15),this.scene.add(s);const a=new THREE.PointLight(16711935,1.5,60);a.position.set(-15,10,-15),this.scene.add(a);const f=new THREE.PointLight(16777215,1,40);f.position.set(0,20,0),this.scene.add(f);const l=new THREE.GridHelper(100,100,65535,657966);l.position.y=-18,this.scene.add(l),this.nodes=[],this.lines=[];const u=new THREE.BufferGeometry,p=1500,m=new Float32Array(p*3);for(let w=0;w<p*3;w++)m[w]=(Math.random()-.5)*100;u.setAttribute("position",new THREE.BufferAttribute(m,3));const E=new THREE.PointsMaterial({size:.05,color:65535,transparent:!0,opacity:.6});this.particles=new THREE.Points(u,E),this.scene.add(this.particles),this.frame=0,this.gizmoGroup=null,this.axisDragging=null,this.axisDragStart=null}createGizmo(){if(this.gizmoGroup)return this.gizmoGroup;const e=new THREE.Group,n=new THREE.CylinderGeometry(.06,.06,1,8),i=new THREE.ConeGeometry(.12,.2,8),o=new THREE.MeshBasicMaterial({color:16711680}),r=new THREE.Mesh(n,o);r.rotation.z=-Math.PI/2,r.position.x=.5;const s=new THREE.Mesh(i,o);s.rotation.z=-Math.PI/2,s.position.x=1.05;const a=new THREE.Group;a.add(r),a.add(s),a.userData={axis:"x"};const f=new THREE.MeshBasicMaterial({color:65280}),l=new THREE.Mesh(n,f);l.position.y=.5;const u=new THREE.Mesh(i,f);u.position.y=1.05;const p=new THREE.Group;p.add(l),p.add(u),p.userData={axis:"y"};const m=new THREE.MeshBasicMaterial({color:255}),E=new THREE.Mesh(n,m);E.rotation.x=Math.PI/2,E.position.z=.5;const w=new THREE.Mesh(i,m);w.rotation.x=Math.PI/2,w.position.z=1.05;const x=new THREE.Group;return x.add(E),x.add(w),x.userData={axis:"z"},e.add(a,p,x),e.visible=!1,this.scene.add(e),this.gizmoGroup=e,e}showGizmoAt(e){e&&(this.createGizmo(),this.gizmoGroup.position.copy(e.position),this.gizmoGroup.visible=!0)}hideGizmo(){this.gizmoGroup&&(this.gizmoGroup.visible=!1)}updateGizmoPosition(e){!this.gizmoGroup||!e||this.gizmoGroup.position.copy(e.position)}_closestPointOnAxisToRay(e,n,i){const o=n.clone(),r=i.clone().normalize(),s=e.origin.clone(),a=e.direction.clone().normalize(),f=o.clone().sub(s),l=r.dot(r),u=r.dot(a),p=a.dot(a),m=r.dot(f),E=a.dot(f),w=l*p-u*u;let x=0;return Math.abs(w)>1e-6?x=(u*E-p*m)/w:x=0,o.add(r.multiplyScalar(x))}gizmoPointerDown(e){if(!this.gizmoGroup||!this.gizmoGroup.visible)return null;const n=e.intersectObjects(this.gizmoGroup.children,!0);if(n&&n.length){let i=n[0].object;for(;i&&!i.userData.axis;)i=i.parent;if(i&&i.userData&&i.userData.axis)return this.axisDragging=i.userData.axis,this.axisDragStart=this._closestPointOnAxisToRay(e.ray,this.gizmoGroup.position.clone(),new THREE.Vector3(this.axisDragging==="x"?1:0,this.axisDragging==="y"?1:0,this.axisDragging==="z"?1:0)),this.axisDragging}return null}gizmoPointerMove(e,n){if(!this.axisDragging||!n)return null;const i=new THREE.Vector3(this.axisDragging==="x"?1:0,this.axisDragging==="y"?1:0,this.axisDragging==="z"?1:0),o=this._closestPointOnAxisToRay(e.ray,this.gizmoGroup.position.clone(),i);return o?(n.position.copy(o),this.updateGizmoPosition(n),o):null}gizmoPointerUp(){this.axisDragging&&(this.axisDragging=null,this.axisDragStart=null)}createTextMesh(e,n){const i=document.createElement("canvas"),o=i.getContext("2d");i.width=1024,i.height=128,o.clearRect(0,0,i.width,i.height),o.font="54px Orbitron, sans-serif",o.textAlign="center",o.textBaseline="middle",o.shadowColor=n,o.shadowBlur=15,o.fillStyle=n,o.fillText(e.toUpperCase(),i.width/2,i.height/2);const r=new THREE.CanvasTexture(i);r.needsUpdate=!0;const s=new THREE.PlaneGeometry(4.5,.56),a=new THREE.MeshBasicMaterial({map:r,transparent:!0,side:THREE.DoubleSide,depthTest:!0}),f=new THREE.Mesh(s,a),l=new THREE.PlaneGeometry(4.6,.66),u=new THREE.MeshBasicMaterial({color:1296,transparent:!0,opacity:.8,side:THREE.DoubleSide}),p=new THREE.Mesh(l,u);p.position.z=-.05;const m=new THREE.Group;m.add(p),m.add(f);const E=new THREE.EdgesGeometry(new THREE.PlaneGeometry(4.6,.66)),w=new THREE.LineBasicMaterial({color:n,linewidth:2}),x=new THREE.LineSegments(E,w);return m.add(x),m}createNode(e,n,i,o=1,r=null){const s=new THREE.Group,a=new THREE.Group,f=new THREE.BoxGeometry(.6*o,.6*o,.6*o),l=new THREE.EdgesGeometry(f),u=new THREE.LineBasicMaterial({color:i,linewidth:2}),p=new THREE.LineSegments(l,u);a.add(p);const m=new THREE.BoxGeometry(.4*o,.4*o,.4*o),E=new THREE.MeshBasicMaterial({color:i,transparent:!0,opacity:.3,wireframe:!0}),w=new THREE.Mesh(m,E);a.add(w);const x=new THREE.PointLight(i,.5,5);a.add(x),s.add(a);try{const X=this.createTextMesh(e,i);X.position.y=1.5*o,s.add(X)}catch(X){console.warn("Failed to create text mesh:",X)}s.position.set(...n);const $=r||Math.random().toString(36).slice(2,9);return s.userData={id:$,name:e,rotationSpeed:Math.random()*.01+.005,rotatingGroup:a},this.scene.add(s),this.nodes.push(s),s}createLineWithIds(e,n,i,o=null,r=null,s=.5){const a=[new THREE.Vector3(...e),new THREE.Vector3(...n)],f=new THREE.BufferGeometry().setFromPoints(a),l=new THREE.LineBasicMaterial({color:i,transparent:!0,opacity:s}),u=new THREE.Line(f,l);return u.userData={startId:o,endId:r},this.scene.add(u),this.lines.push(u),u}getSceneNodeById(e){return this.nodes.find(n=>n.userData&&n.userData.id===e)||null}createChildNodes(e,n,i,o,r){e.forEach(s=>{if(s.name){const a=r?r(s):this.colorResolver(s),f=this.createNode(s.name,s.pos,a,s.scale||1,s.id||null),l=n&&n.userData?n.userData.id:null;this.createLineWithIds(i,s.pos,o,l,s.id||null),s.children&&s.children.length>0&&this.createChildNodes(s.children,f,s.pos,a,r)}})}updateSceneNodeColor(e,n){if(!(!e||!n))try{const i=e.userData&&e.userData.rotatingGroup;i&&i.children&&i.children.forEach(o=>{o.material&&o.material.color&&o.material.color.set(n),(o.isPointLight||o.type==="PointLight")&&o.color&&o.color.set&&o.color.set(n)}),e.children.forEach(o=>{o.type==="Group"&&o.children.forEach(r=>{r.material&&r.material.color&&r.material.color.set(n)})})}catch(i){console.warn("Failed to update scene node color",i)}}rebuildScene(e,n=null){if(this.nodes.forEach(i=>this.scene.remove(i)),this.lines.forEach(i=>this.scene.remove(i)),this.nodes.length=0,this.lines.length=0,e.root&&e.root.name&&e.root.name!=="Empty Architecture"){e.root.id||(e.root.id=Math.random().toString(36).slice(2,9));const i=this.colorResolver?this.colorResolver(e.root):"#666666",o=this.createNode(e.root.name,e.root.pos,i,e.root.scale,e.root.id);e.root.children&&e.root.children.length>0&&this.createChildNodes(e.root.children,o,e.root.pos,i,null)}return n&&this.getSceneNodeById(n)||null}update(e){this.frame=e,this.nodes.forEach(n=>{n.userData&&n.userData.rotatingGroup&&(n.userData.rotatingGroup.rotation.y+=n.userData.rotationSpeed,n.userData.rotatingGroup.rotation.x+=n.userData.rotationSpeed*.5)}),this.lines.forEach((n,i)=>{if(n.material.opacity=.3+Math.sin(e*.05+i)*.2,n.userData&&(n.userData.startId||n.userData.endId)){const o=n.userData.startId?this.getSceneNodeById(n.userData.startId):null,r=n.userData.endId?this.getSceneNodeById(n.userData.endId):null;if(o||r){const s=n.geometry.attributes.position,a=s.array;o&&(a[0]=o.position.x,a[1]=o.position.y,a[2]=o.position.z),r&&(a[3]=r.position.x,a[4]=r.position.y,a[5]=r.position.z),s.needsUpdate=!0,n.geometry.computeBoundingSphere()}}}),this.particles&&(this.particles.rotation.y+=3e-4,this.particles.rotation.x+=1e-4)}render(){this.renderer.render(this.scene,this.camera)}resize(e=window.innerWidth,n=window.innerHeight){this.camera.aspect=e/n,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,n)}}let d={getArchitecture:null,setArchitecture:null,getSelectedId:null,getSelectedNode:null,setSelectedId:null,setSelectedNode:null,getEditMode:null,setEditMode:null,findNodeById:null,rebuildScene:null,updateSceneNodeColor:null,archRenderer:null};function Xe(t){d=Object.assign(d,t||{});try{W()}catch{}try{ue()}catch{}}function ae(t){try{const e=document.getElementById("messageDisplay");if(!e)return;const n=document.createElement("div");n.className="message",n.textContent=t,e.appendChild(n),setTimeout(()=>{try{n.remove()}catch{}},5e3)}catch(e){console.warn("addMessage failed",e)}}function Q(){const t=document.getElementById("legendItems"),e=document.getElementById("legendContainer");if(!t)return;t.innerHTML="";const i=(d.getArchitecture?d.getArchitecture():{legend:[]}).legend||[];i.forEach(o=>{const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="8px",r.style.marginBottom="6px";const s=document.createElement("div");s.style.width="12px",s.style.height="12px",s.style.background=o.color||"#00ffff",s.style.border="1px solid rgba(255,255,255,0.1)",s.style.boxSizing="border-box";const a=document.createElement("div");a.style.color="#00ffff",a.style.fontSize="12px",a.textContent=o.name||"",r.appendChild(s),r.appendChild(a),t.appendChild(r)}),e&&(e.style.display=i.length?"":"none")}function ue(){const t=document.getElementById("legendList");if(!t)return;t.innerHTML="";const n=(d.getArchitecture?d.getArchitecture():{legend:[]}).legend||[],i=d.getEditMode?d.getEditMode():!1;n.forEach((o,r)=>{const s=document.createElement("div");s.className="legend-row",i?s.innerHTML=`
        <input type="text" class="legend-name" data-idx="${r}" value="${o.name}" />
        <div class="legend-swatch" data-idx="${r}" title="Click to change color" style="width:28px;height:28px;border:1px solid #00ffff;background:${o.color};box-sizing:border-box;cursor:pointer;"></div>
        <button class="button small legend-remove" data-idx="${r}">DEL</button>
      `:s.innerHTML=`
        <div style="flex:1;color:#00ffff;">${o.name}</div>
        <div style="width:12px;height:12px;background:${o.color};border:1px solid rgba(255,255,255,0.1);"></div>
      `,t.appendChild(s)}),i&&(t.querySelectorAll(".legend-name").forEach(o=>{o.addEventListener("change",r=>{const s=parseInt(r.target.dataset.idx,10),a=d.getArchitecture?d.getArchitecture():{legend:[]};if(a.legend[s]){a.legend[s].name=r.target.value;try{Q()}catch{}try{W()}catch{}}})}),t.querySelectorAll(".legend-swatch").forEach(o=>{o.addEventListener("click",r=>{const s=parseInt(o.dataset.idx,10),a=d.getArchitecture?d.getArchitecture():{legend:[]};if(isNaN(s)||!a.legend[s])return;const f=a.legend[s].color||"#00ffff";Fe(o,f,l=>{a.legend[s].color=l;try{Q()}catch{}try{d.rebuildScene&&d.rebuildScene()}catch{}})})}),t.querySelectorAll(".legend-remove").forEach(o=>{o.addEventListener("click",r=>{const s=parseInt(r.target.dataset.idx,10),a=d.getArchitecture?d.getArchitecture():{legend:[]};if(s>=0&&s<a.legend.length){a.legend.splice(s,1);try{Q()}catch{}try{W()}catch{}}})}))}function Fe(t,e,n){try{const i=t.getBoundingClientRect(),o=document.createElement("input");o.type="color",o.value=e||"#00ffff",o.style.position="absolute",o.style.left=i.left+window.scrollX+"px",o.style.top=i.top+window.scrollY+"px",o.style.width=i.width+"px",o.style.height=i.height+"px",o.style.zIndex=1e5,o.style.border="none",o.style.padding="0",o.style.margin="0",o.style.background="transparent",o.style.opacity="0.01",document.body.appendChild(o);let r=!1;const s=()=>{if(!r){r=!0;try{o.remove()}catch{}try{document.removeEventListener("mousedown",f,!0)}catch{}try{clearTimeout(l)}catch{}}},a=u=>{try{n&&n(u)}catch(p){console.warn("onPick handler error",p)}};o.addEventListener("input",u=>{a(u.target.value)}),o.addEventListener("change",u=>{a(u.target.value),s()}),o.addEventListener("blur",()=>{setTimeout(s,200)});const f=u=>{o.contains(u.target)||s()};document.addEventListener("mousedown",f,!0);const l=setTimeout(()=>{s()},6e3);o.click()}catch(i){console.warn("color picker fallback",i)}}function W(){const t=document.getElementById("assignLegendSelect");if(!t)return;t.innerHTML="";const e=document.createElement("option");e.value="",e.textContent="-- none --",t.appendChild(e),((d.getArchitecture?d.getArchitecture():{legend:[]}).legend||[]).forEach(i=>{const o=document.createElement("option");o.value=i.id||i.name,o.textContent=i.name,t.appendChild(o)}),t.onchange=function(){try{const i=d.getSelectedId?d.getSelectedId():null;if(!i){console.warn("assignLegendSelect: no selected id");return}const o=d.getSelectedNode?d.getSelectedNode():d.archRenderer?d.archRenderer.getSceneNodeById(i):null,r=t.value===""?"":t.value,s=d.getArchitecture?d.getArchitecture():null,a=d.findNodeById&&s?d.findNodeById(s.root,i):null;if(!a){console.warn("assignLegendSelect: arch node not found",i);return}r?a.category=r:delete a.category;const f=(d.getArchitecture().legend||[]).find(l=>l.id===r);if(f&&o)try{d.updateSceneNodeColor&&d.updateSceneNodeColor(o,f.color)}catch{}try{d.rebuildScene&&d.rebuildScene()}catch{}}catch(i){console.error("assignLegendSelect onchange error",i)}}}function Ye(){try{Q()}catch(t){console.warn(t)}try{ue()}catch{}try{W()}catch{}}function Oe(){const t=document.getElementById("title"),e=d.getArchitecture?d.getArchitecture():{},n=e&&e.uiInfo&&e.uiInfo.title?e.uiInfo.title:e&&e.root&&e.root.name?e.root.name:"ARCHITECTURE VISUALIZATION";t&&(t.textContent=n);try{document.title=n}catch{}}function Se(){if(window.__selectedIndicatorElement)return window.__selectedIndicatorElement;const t=document.createElement("div");return t.className="selected-node-indicator",document.body.appendChild(t),window.__selectedIndicatorElement=t,t}function pe(){if(window.__renameInputEl)return window.__renameInputEl;const t=document.createElement("input");return t.type="text",t.style.position="absolute",t.style.zIndex=90,t.style.display="none",t.style.padding="6px 8px",t.style.border="1px solid #00ffff",t.style.background="rgba(0,0,0,0.8)",t.style.color="#00ffff",t.style.fontFamily="Orbitron, sans-serif",document.body.appendChild(t),window.__renameInputEl=t,t}function $e(){const t=pe(),e=d.getSelectedId?d.getSelectedId():null,n=d.getSelectedNode?d.getSelectedNode():d.archRenderer?d.archRenderer.getSceneNodeById(e):null;if(!n)return;const o=n.position.clone().project(d.archRenderer.camera),r=(o.x*.5+.5)*window.innerWidth,s=(-o.y*.5+.5)*window.innerHeight;t.style.left=r+24+"px",t.style.top=s-12+"px",t.value=n.userData.name||"",t.style.display="block",t.focus()}function Ue(){const t=window.__selectedIndicatorElement;if(!t)return;const e=d.getSelectedId?d.getSelectedId():null,n=d.getSelectedNode?d.getSelectedNode():d.archRenderer?d.archRenderer.getSceneNodeById(e):null;if(!n)return;const o=n.position.clone().project(d.archRenderer.camera),r=(o.x*.5+.5)*window.innerWidth,s=(-o.y*.5+.5)*window.innerHeight;t.style.left=r+"px",t.style.top=s+"px"}function _e(){const t=document.getElementById("editName"),e=document.getElementById("editScale"),n=document.getElementById("editPosX"),i=document.getElementById("editPosY"),o=document.getElementById("editPosZ"),r=()=>{const s=d.getSelectedId?d.getSelectedId():null;if(!s)return;const a=d.getSelectedNode?d.getSelectedNode():d.archRenderer?d.archRenderer.getSceneNodeById(s):null;if(!a)return;const f=t.value.trim(),l=parseFloat(e.value)||1,u=parseFloat(n.value)||0,p=parseFloat(i.value)||0,m=parseFloat(o.value)||0;a.userData.name=f,a.position.set(u,p,m);const E=d.getArchitecture?d.getArchitecture():null,w=d.findNodeById&&E?d.findNodeById(E.root,s):null;w&&(w.name=f,w.scale=l,w.pos=[u,p,m]);try{d.rebuildScene&&d.rebuildScene()}catch{}};t&&t.addEventListener("change",r),e&&e.addEventListener("change",r),n&&n.addEventListener("change",r),i&&i.addEventListener("change",r),o&&o.addEventListener("change",r)}function qe(){((e,n,i)=>{const o=document.getElementById(e);o&&(o.dataset&&o.dataset.wired||(o.addEventListener(n,i),o.dataset.wired="1"))})("editBtn","click",()=>{if(!d.getEditMode||!d.setEditMode)return;if(!d.getEditMode()&&window.innerWidth<900){ae("Edit mode is available on desktop only.");return}d.setEditMode(!d.getEditMode());const e=document.getElementById("editBtn");if(e&&(e.classList.toggle("active",d.getEditMode()),e.textContent=d.getEditMode()?"✖️ EXIT EDITOR":"✏️ EDIT"),d.getEditMode()){ue(),W();const n=document.getElementById("nodeEditorHeader");n&&(n.style.display="");const i=document.getElementById("editPanel");i&&(i.style.display="",i.setAttribute("aria-hidden","false")),Se(),pe(),ae("Edit mode enabled: use gizmo arrows to move nodes, double-click to rename.");const o=document.getElementById("legendEditor");o&&(o.style.display=""),["saveBtn","loadBtn","sampleBtn"].forEach(s=>{const a=document.getElementById(s);if(a){try{a.dataset._wasHiddenByEdit=a.style.display==="none"?"1":""}catch{}a.style.display="none"}});const r=document.querySelector(".smoothness-control");if(r){try{r.dataset._wasHiddenByEdit=r.style.display==="none"?"1":""}catch{}r.style.display="none"}}else{const n=document.getElementById("nodeEditorHeader");n&&(n.style.display="none");const i=document.getElementById("editPanel");i&&(i.style.display="none",i.setAttribute("aria-hidden","true"));const o=window.__selectedIndicatorElement;o&&(o.style.display="none");const r=window.__renameInputEl;r&&(r.style.display="none");try{d.archRenderer&&d.archRenderer.hideGizmo()}catch{}ae("Edit mode disabled. Auto-rotate will resume after inactivity.");const s=document.getElementById("legendEditor");s&&(s.style.display="none"),["saveBtn","loadBtn","sampleBtn"].forEach(f=>{const l=document.getElementById(f);if(l)try{l.dataset&&l.dataset._wasHiddenByEdit?delete l.dataset._wasHiddenByEdit:l.style.display=""}catch{l.style.display=""}});const a=document.querySelector(".smoothness-control");if(a)try{a.dataset&&a.dataset._wasHiddenByEdit?delete a.dataset._wasHiddenByEdit:a.style.display=""}catch{a.style.display=""}}})}const y={init:Xe,addMessage:ae,updateLeftLegendDisplay:Q,renderLegendEditor:ue,renderLegendAssignSelect:W,updateLegend:Ye,updateTitle:Oe,ensureSelectedIndicator:Se,ensureRenameInput:pe,showRenameInputAtSelected:$e,updateSelectedIndicatorPosition:Ue,attachImmediateEditHandlers:_e,wireUiHandlers:qe};let c={root:{name:"Empty Architecture",pos:[0,0,0],color:"#666666",scale:1,children:[]},legend:[],uiInfo:{title:""}},A=!0,ne=!0,L=null;if("serviceWorker"in navigator)try{navigator.serviceWorker.getRegistrations().then(t=>{t&&t.length&&console.info("Found",t.length,"service worker registrations — attempting to unregister them to avoid stale cache."),t.forEach(e=>e.unregister().then(n=>{console.info("Service worker unregistered:",n,e)}).catch(n=>console.warn("SW unregister error",n)))}).catch(t=>console.warn("Error getting SW registrations",t)),window.caches&&typeof window.caches.keys=="function"&&caches.keys().then(t=>{t.forEach(e=>{caches.delete(e).then(n=>{console.info("Cache deleted:",e,n)}).catch(n=>console.warn("Cache delete failed",e,n))})}).catch(t=>console.warn("Error listing caches",t))}catch(t){console.warn("Service worker cleanup failed",t)}const I=new Ge({mountElement:document.getElementById("canvas")}),ee=I.scene,F=I.camera,te=I.renderer,Ie=I.nodes;I.lines;te.setClearColor(1296);document.getElementById("canvas").appendChild(te.domElement);try{y.init({getArchitecture:()=>c,setArchitecture:t=>{c=t},getSelectedId:()=>L,getSelectedNode:()=>h||(L?I.getSceneNodeById(L):null),setSelectedId:t=>{L=t},setSelectedNode:t=>{h=t},getEditMode:()=>b,setEditMode:t=>{b=t},findNodeById:(t,e)=>j(t,e),rebuildScene:()=>G(),updateSceneNodeColor:I.updateSceneNodeColor.bind(I),archRenderer:I})}catch(t){console.warn("UI.init failed",t)}const je=new THREE.AmbientLight(1710654,.8);ee.add(je);const Be=new THREE.PointLight(65535,1.5,60);Be.position.set(15,15,15);ee.add(Be);const Te=new THREE.PointLight(16711935,1.5,60);Te.position.set(-15,10,-15);ee.add(Te);const Me=new THREE.PointLight(16777215,1,40);Me.position.set(0,20,0);ee.add(Me);const Re=new THREE.GridHelper(100,100,65535,657966);Re.position.y=-18;ee.add(Re);function De(t){if(!t)return"#666666";if(t.category){const e=(c.legend||[]).find(n=>n.id===t.category||n.name===t.category);if(e&&e.color)return e.color}return t.color?t.color:"#666666"}try{I&&(I.colorResolver=De)}catch(t){console.warn("Failed to set archRenderer.colorResolver",t)}try{I&&(I.colorResolver=De)}catch{}function G(){const t=L||(h&&h.userData?h.userData.id:null),e=I.rebuildScene(c,t);e?(h=e,L=e.userData&&e.userData.id?e.userData.id:L,P&&(P.style.display="block"),updateSelectedIndicatorPosition(),ce()):(h=null,L=null,P&&(P.style.display="none"),ce())}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("saveBtn"),e=document.getElementById("loadBtn"),n=document.getElementById("sampleBtn"),i=document.getElementById("xmlFileInput");t&&t.addEventListener("click",()=>{if(!c.root||c.root.name==="Empty Architecture"||!c.root.name){y.addMessage("No architecture to save. Please load an architecture first.");return}const a=fe.architectureToXML(c),f=new Blob([a],{type:"application/xml"}),l=URL.createObjectURL(f),u=document.createElement("a");u.href=l,u.download="architecture.xml",document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(l),y.addMessage("Architecture saved successfully!")}),e&&e.addEventListener("click",()=>{i&&i.click()}),i&&i.addEventListener("change",a=>{const f=a.target.files[0];if(!f)return;const l=new FileReader;l.onload=u=>{try{const p=u.target.result;if(!p||p.trim()==="")throw new Error("Empty file");const m=fe.xmlToArchitecture(p);if(!m||!m.root)throw new Error("Invalid architecture structure");c={root:m.root||{name:"Unknown Root",pos:[0,0,0],color:"#ff00ff",scale:1,children:[]},legend:m.legend||[],uiInfo:m.uiInfo||{title:""}},we(c.root,c.legend),me(c.root);try{y.updateLegend()}catch(E){console.warn("UI.updateLegend failed",E)}try{y.updateTitle()}catch(E){console.warn("UI.updateTitle failed",E)}G(),y.addMessage("Architecture loaded successfully!")}catch(p){y.addMessage("Error loading XML file: "+p.message)}},l.readAsText(f),a.target.value=""}),n&&n.addEventListener("click",()=>{const a=`<?xml version="1.0" encoding="UTF-8"?>
<arch>
  <node name="ROOT" pos="0,0,0" color="#00ffff" scale="1">
	<node name="API Gateway" pos="10,5,0" color="#ff00ff" scale="0.8">
	  <node name="Auth Service" pos="15,8,5" color="#ffff00" scale="0.6" />
	  <node name="Rate Limiter" pos="15,8,-5" color="#ffff00" scale="0.6" />
	</node>
	<node name="Database Layer" pos="-10,5,0" color="#00ff00" scale="0.8">
	  <node name="Primary DB" pos="-15,8,5" color="#ffff00" scale="0.6" />
	  <node name="Cache" pos="-15,8,-5" color="#ffff00" scale="0.6" />
	</node>
	<node name="Workers" pos="0,-5,10" color="#ff6600" scale="0.8">
	  <node name="Job Queue" pos="5,-8,15" color="#ffff00" scale="0.6" />
	  <node name="Worker Pool" pos="-5,-8,15" color="#ffff00" scale="0.6" />
	</node>
  </node>
  <legend>
	<entry name="Core Services" color="#00ffff" />
	<entry name="Modules" color="#ff00ff" />
	<entry name="Components" color="#ffff00" />
	<entry name="Data Layer" color="#00ff00" />
  </legend>
  <ui-info>
	<title>MICROSERVICES ARCHITECTURE</title>
  </ui-info>
</arch>`;try{c=fe.xmlToArchitecture(a),we(c.root,c.legend),me(c.root);try{y.updateLegend()}catch(l){console.warn("UI.updateLegend failed",l)}try{y.updateTitle()}catch(l){console.warn("UI.updateTitle failed",l)}G(),y.addMessage("Sample architecture loaded successfully!")}catch(f){y.addMessage("Error loading sample: "+f.message)}});const o=document.getElementById("mobileSaveBtn"),r=document.getElementById("mobileLoadBtn"),s=document.getElementById("mobileSampleBtn");o&&o.addEventListener("click",()=>{t&&t.click()}),r&&r.addEventListener("click",()=>{e&&e.click()}),s&&s.addEventListener("click",()=>{n&&n.click()})});const v={w:!1,a:!1,s:!1,d:!1,shift:!1,space:!1},g={leftTouchId:null,rightTouchId:null,leftStart:null,rightStart:null,leftPos:{x:0,y:0},rightPos:{},maxRadius:44};g.upPressed=!1;g.downPressed=!1;let M=0,de=0,oe=50,Y=50,he=15,O=15,ie=0,C=0,re=0,U=0,se=0,H=0,Z=!1,V=!1,N=0,k=0,_=!0,ge,xe=0,b=!1,h=null,P=null;const K=new THREE.Raycaster,S=new THREE.Vector2;function ye(){clearTimeout(ge);const t=()=>{b?ge=setTimeout(t,1e3):_=!0};ge=setTimeout(t,3e3)}document.addEventListener("keydown",t=>{const e=t.key.toLowerCase();e==="w"&&(v.w=!0),e==="a"&&(v.a=!0),e==="s"&&(v.s=!0),e==="d"&&(v.d=!0),t.key==="Shift"&&(v.shift=!0),t.key===" "&&(v.space=!0),t.key==="Escape"&&document.pointerLockElement===document.getElementById("canvas")&&document.exitPointerLock()});document.addEventListener("keyup",t=>{const e=t.key.toLowerCase();e==="w"&&(v.w=!1),e==="a"&&(v.a=!1),e==="s"&&(v.s=!1),e==="d"&&(v.d=!1),t.key==="Shift"&&(v.shift=!1),t.key===" "&&(v.space=!1)});document.addEventListener("mousedown",t=>{if(b){if(t.button===0&&(Z=!0,N=t.clientX,k=t.clientY,_=!1),t.button===1||t.button===2){t.preventDefault(),V=!0,N=t.clientX,k=t.clientY,_=!1;return}return}t.button===0?(Z=!0,N=t.clientX,k=t.clientY,_=!1):(t.button===1||t.button===2)&&(t.preventDefault(),V=!0,N=t.clientX,k=t.clientY,_=!1)});document.addEventListener("mouseup",()=>{Z=!1,V=!1});function We(){const t=L||h&&h.userData&&h.userData.id;if(!t)return;const e=h||I.getSceneNodeById(t);if(!e)return;const n=j(c.root,t);n?n.pos=[e.position.x,e.position.y,e.position.z]:c.root&&c.root.id===t&&(c.root.pos=[e.position.x,e.position.y,e.position.z]),G()}function ce(){const t=document.getElementById("editPanel");if(!t)return;if(!b){t.style.display="none",t.setAttribute("aria-hidden","true");return}const e=document.getElementById("editContent");if(h=h||(L?I.getSceneNodeById(L):null),!h){t.style.display="block",t.setAttribute("aria-hidden","false"),e&&(e.innerHTML='<div style="color:#00ffff;font-size:12px;padding:6px;">Select a node to edit it</div>');return}const n=j(c.root,h.userData.id)||(c.root.name===h.userData.name?c.root:null),i=!n&&(c.root.name===h.userData.name?c.root:null);t.style.display="block",t.setAttribute("aria-hidden","false");const o=document.getElementById("editName"),r=document.getElementById("editScale"),s=document.getElementById("editPosX"),a=document.getElementById("editPosY"),f=document.getElementById("editPosZ"),l=n||i?n||i:null;if(l){const p=document.getElementById("editContent");if(p&&p.querySelector("#editName")==null){p.innerHTML=`
				<div class="edit-row"><label>Name</label><input type="text" id="editName"></div>
				<div style="display:flex;gap:8px;margin-top:8px;align-items:center;"><select id="assignLegendSelect" style="flex:1;padding:6px;background:rgba(0,0,0,0.6);border:1px solid #00ffff;color:#00ffff;"></select></div>
				<div class="edit-row"><label>Scale</label><input type="number" id="editScale" step="0.1" min="0.1"></div>
				<div class="edit-row"><label>Pos X</label><input type="number" id="editPosX" step="0.1"></div>
				<div class="edit-row"><label>Pos Y</label><input type="number" id="editPosY" step="0.1"></div>
				<div class="edit-row"><label>Pos Z</label><input type="number" id="editPosZ" step="0.1"></div>
				<div class="edit-actions"><button class="button small" id="addChildBtn">+ CHILD</button><button class="button small danger" id="deleteNodeBtn">DELETE</button></div>
			`;try{y.attachImmediateEditHandlers()}catch(X){console.warn("UI.attachImmediateEditHandlers failed",X)}try{document.getElementById("addChildBtn").addEventListener("click",()=>{})}catch{}}const m=document.getElementById("editName"),E=document.getElementById("editScale"),w=document.getElementById("editPosX"),x=document.getElementById("editPosY"),$=document.getElementById("editPosZ");m&&(m.value=l.name||h.userData.name||""),E&&(E.value=l.scale||1),w&&(w.value=(h.position.x||0).toFixed(2)),x&&(x.value=(h.position.y||0).toFixed(2)),$&&($.value=(h.position.z||0).toFixed(2))}else o&&(o.value=h.userData.name||""),r&&(r.value=1),s&&(s.value=(h.position.x||0).toFixed(2)),a&&(a.value=(h.position.y||0).toFixed(2)),f&&(f.value=(h.position.z||0).toFixed(2));try{y.renderLegendAssignSelect()}catch{}const u=document.getElementById("assignLegendSelect");if(u){const p=j(c.root,h.userData.id);let m="";if(p&&p.category&&(m=p.category),m!==""){const E=parseInt(m,10);if(!isNaN(E)&&c.legend&&c.legend[E])m=c.legend[E].id;else if(!(c.legend||[]).find(x=>x.id===m)){const x=(c.legend||[]).find($=>$.name===m);x?m=x.id:m=""}}u.value=m||""}}const ve=document.getElementById("addLegendBtn");ve&&ve.addEventListener("click",()=>{const t=document.getElementById("newLegendName"),e=document.getElementById("newLegendSwatch");if(!t||!e)return;const n=t.value.trim(),i=e.style.backgroundColor||"#00ffff";if(!n){y.addMessage("Legend name required");return}c.legend||(c.legend=[]);const o={id:Math.random().toString(36).slice(2,9),name:n,color:i};c.legend.push(o),t.value="",e.style.backgroundColor="#00ffff";try{y.updateLegend()}catch(r){console.warn("UI.updateLegend failed",r)}try{y.renderLegendEditor()}catch{}try{y.renderLegendAssignSelect()}catch{}y.addMessage("Legend added")});const J=document.getElementById("newLegendSwatch");J&&J.addEventListener("click",()=>{const t=J.style.backgroundColor||"#00ffff";try{y.openColorPickerNear(J,t,e=>{J.style.backgroundColor=e})}catch(e){console.warn("UI.openColorPickerNear failed",e)}});document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("legendList");t&&(t.addEventListener("click",e=>{const n=e.target;if(n.classList&&n.classList.contains("legend-swatch")){const i=parseInt(n.dataset.idx,10);if(isNaN(i)||!c.legend[i])return;const o=c.legend[i].color||"#00ffff";try{y.openColorPickerNear(n,o,r=>{c.legend[i].color=r,updateLegend(),G()})}catch(r){console.warn("UI.openColorPickerNear failed",r)}return}if(n.classList&&n.classList.contains("legend-remove")){const i=parseInt(n.dataset.idx,10);!isNaN(i)&&i>=0&&i<c.legend.length&&(c.legend.splice(i,1),updateLegend(),renderLegendAssignSelect());return}},!0),t.addEventListener("input",e=>{const n=e.target;if(n.classList&&n.classList.contains("legend-name")){const i=parseInt(n.dataset.idx,10);!isNaN(i)&&c.legend[i]&&(c.legend[i].name=n.value,updateLeftLegendDisplay())}},!0))});document.addEventListener("DOMContentLoaded",()=>{try{y.renderLegendAssignSelect()}catch{}const t=document.getElementById("legendEditor");t&&(t.style.display=b?"":"none");const e=document.getElementById("editPanel");e&&(e.style.display=b?"":"none",e.setAttribute("aria-hidden",b?"false":"true"));const n=document.getElementById("nodeEditorHeader");n&&(n.style.display=b?"":"none");try{y.renderLegendEditor()}catch{}});try{y.attachImmediateEditHandlers()}catch{}document.getElementById("addChildBtn").addEventListener("click",()=>{if(!b){y.addMessage("Enter Edit mode to add nodes.");return}if(!c.root||!c.root.name||c.root.name==="Empty Architecture"){c.root={id:Math.random().toString(36).slice(2,9),name:"ROOT",pos:[0,0,0],color:"#00ffff",scale:1,children:[]},me(c.root),G(),y.addMessage("Root node created");return}const t=h||(L?I.getSceneNodeById(L):null),e={id:Math.random().toString(36).slice(2,9),name:"New Node",pos:t?[t.position.x+5,t.position.y,t.position.z]:[c.root.pos[0]+5,c.root.pos[1],c.root.pos[2]],scale:.6,children:[]};if(t){const n=j(c.root,t.userData.id)||(c.root.name===t.userData.name?c.root:null);n?(n.children||(n.children=[]),n.children.push(e)):(c.root.children||(c.root.children=[]),c.root.children.push(e))}else c.root.children||(c.root.children=[]),c.root.children.push(e);G(),y.addMessage("Child node added")});document.getElementById("deleteNodeBtn").addEventListener("click",()=>{if(!h)return;const t=h.userData.id;if(c.root.id===t){y.addMessage("Cannot delete root node");return}if(!ze(c.root,t)){y.addMessage("Failed to delete node (mapping not found)");return}h=null,G(),y.addMessage("Node deleted")});try{y.wireUiHandlers()}catch{}document.addEventListener("DOMContentLoaded",()=>{try{y.wireUiHandlers()}catch{}});document.addEventListener("DOMContentLoaded",()=>{try{const t=document.getElementById("uiToggle");t&&t.classList.toggle("visible",!A);const e=document.getElementById("rightPanel"),n=document.getElementById("leftPanel");e&&(e.style.display=A?"block":"none"),n&&(n.style.display=A?"block":"none")}catch{}});document.addEventListener("keydown",t=>{try{const e=(t.key||"").toLowerCase();if(e==="u"){A=!A;const n=document.getElementById("rightPanel"),i=document.getElementById("leftPanel");n&&(n.style.display=A?"block":"none"),i&&(i.style.display=A?"block":"none");const o=document.getElementById("uiToggle");o&&o.classList.toggle("visible",!A);try{y.addMessage(`UI ${A?"visible":"hidden"}`)}catch{}}if(e==="q"){ne=!ne,document.body.style.cursor=ne?"default":"none";try{y.addMessage(`Cursor ${ne?"visible":"hidden"}`)}catch{}}}catch{}});document.addEventListener("click",t=>{if(!b||t.target.closest(".ui-container")||t.target.closest(".panel-box")||t.target.closest(".button"))return;const e=te.domElement.getBoundingClientRect();S.x=(t.clientX-e.left)/e.width*2-1,S.y=-((t.clientY-e.top)/e.height)*2+1,K.setFromCamera(S,F);const n=K.intersectObjects(Ie,!0);if(console.log("edit click",{mx:S.x.toFixed(2),my:S.y.toFixed(2),rectWidth:e.width,rectHeight:e.height,intersectsCount:n.length}),n&&n.length){let i=n[0].object;for(;i&&!Ie.includes(i);)i=i.parent;const o=i||n[0].object.parent;if(o&&(L=o.userData&&o.userData.id?o.userData.id:null,h=I.getSceneNodeById(L),h)){try{P=y.ensureSelectedIndicator()}catch(r){console.warn(r)}P&&(P.style.display="block");try{y.updateSelectedIndicatorPosition()}catch{}ce();try{I.showGizmoAt(h)}catch{}}}else h=null,L=null,P&&(P.style.display="none"),ce()});document.addEventListener("mousedown",t=>{if(!b||t.button!==0)return;const e=te.domElement.getBoundingClientRect();S.x=(t.clientX-e.left)/e.width*2-1,S.y=-((t.clientY-e.top)/e.height)*2+1,K.setFromCamera(S,F);try{if(I.gizmoPointerDown(K)){document.body.style.cursor="grabbing",Z=!1,V=!1,t.preventDefault();return}}catch{}});document.addEventListener("mousemove",t=>{if(b)try{const e=te.domElement.getBoundingClientRect();if(S.x=(t.clientX-e.left)/e.width*2-1,S.y=-((t.clientY-e.top)/e.height)*2+1,K.setFromCamera(S,F),I.gizmoPointerMove(K,h)){try{y.updateSelectedIndicatorPosition()}catch{}const i=j(c.root,h.userData.id);i&&(i.pos=[h.position.x,h.position.y,h.position.z])}}catch{}});document.addEventListener("mouseup",t=>{try{I.gizmoPointerUp()}catch{}document.body.style.cursor="default",We()});document.addEventListener("dblclick",t=>{if(!(!b||!h))try{y.showRenameInputAtSelected()}catch{}});const B=document.getElementById("leftStick"),T=document.getElementById("rightStick"),Ae=B&&B.querySelector(".stick-knob"),Pe=T&&T.querySelector(".stick-knob");function Le(t,e,n){t&&(t.style.transform=`translate(${e}px, ${n}px)`)}function be(t){t&&(t.style.transition="transform 150ms ease-out",t.style.transform="translate(0, 0)",setTimeout(()=>t.style.transition="",160))}function Ce(t){ye();for(const e of Array.from(t.changedTouches)){const n=document.elementFromPoint(e.clientX,e.clientY);B&&(n===B||B.contains(n))?(g.leftTouchId=e.identifier,g.leftStart={x:e.clientX,y:e.clientY},g.leftPos={x:0,y:0}):T&&(n===T||T.contains(n))&&(g.rightTouchId=e.identifier,g.rightStart={x:e.clientX,y:e.clientY},g.rightPos={x:0,y:0})}}function He(t){for(const e of Array.from(t.changedTouches))if(e.identifier===g.leftTouchId){const n=e.clientX-g.leftStart.x,i=e.clientY-g.leftStart.y,o=Math.hypot(n,i)||1,r=n/o*Math.min(o,g.maxRadius),s=i/o*Math.min(o,g.maxRadius);g.leftPos={x:r,y:s},Le(Ae,r,s)}else if(e.identifier===g.rightTouchId){const n=e.clientX-g.rightStart.x,i=e.clientY-g.rightStart.y;de-=n*.008,O+=i*.12,O=Math.max(-20,Math.min(35,O)),g.rightStart={x:e.clientX,y:e.clientY},Le(Pe,n*.6,i*.6)}}function Ee(t){for(const e of Array.from(t.changedTouches))e.identifier===g.leftTouchId&&(g.leftTouchId=null,g.leftStart=null,g.leftPos={x:0,y:0},be(Ae)),e.identifier===g.rightTouchId&&(g.rightTouchId=null,g.rightStart=null,be(Pe))}let q=null;function Ne(t,e){const n=t.clientX-e.clientX,i=t.clientY-e.clientY;return Math.hypot(n,i)}function Ze(t){if(t.touches.length===2){const e=Ne(t.touches[0],t.touches[1]);q==null&&(q=e);const n=e-q;Y-=n*.03,Y=Math.max(15,Math.min(100,Y)),q=e}}function Ve(t){t.touches.length<2&&(q=null)}B&&B.addEventListener("touchstart",Ce,{passive:!0});B&&B.addEventListener("touchmove",He,{passive:!1});B&&B.addEventListener("touchend",Ee,{passive:!0});T&&T.addEventListener("touchstart",Ce,{passive:!0});T&&T.addEventListener("touchmove",He,{passive:!1});T&&T.addEventListener("touchend",Ee,{passive:!0});document.addEventListener("touchstart",t=>{t.touches.length===2&&(q=Ne(t.touches[0],t.touches[1])),ye()},{passive:!0});document.addEventListener("touchmove",t=>{t.touches.length===2&&Ze(t),t.touches.length>=1&&t.preventDefault()},{passive:!1});document.addEventListener("touchend",t=>{Ee(t),Ve(t)},{passive:!0});const R=document.getElementById("btnUp"),D=document.getElementById("btnDown");function z(t,e){t&&t.classList.toggle("active",e)}R&&(R.addEventListener("touchstart",t=>{t.preventDefault(),g.upPressed=!0,z(R,!0)},{passive:!1}),R.addEventListener("touchend",t=>{t.preventDefault(),g.upPressed=!1,z(R,!1)},{passive:!0}),R.addEventListener("mousedown",()=>{g.upPressed=!0,z(R,!0)}),R.addEventListener("mouseup",()=>{g.upPressed=!1,z(R,!1)}));D&&(D.addEventListener("touchstart",t=>{t.preventDefault(),g.downPressed=!0,z(D,!0)},{passive:!1}),D.addEventListener("touchend",t=>{t.preventDefault(),g.downPressed=!1,z(D,!1)},{passive:!0}),D.addEventListener("mousedown",()=>{g.downPressed=!0,z(D,!0)}),D.addEventListener("mouseup",()=>{g.downPressed=!1,z(D,!1)}));document.addEventListener("contextmenu",t=>t.preventDefault());document.addEventListener("mousemove",t=>{if(Z){const e=t.clientX-N,n=t.clientY-k;de-=e*.008,O+=n*.15,O=Math.max(-20,Math.min(35,O)),N=t.clientX,k=t.clientY}else if(V){const e=t.clientX-N,n=t.clientY-k,i=new THREE.Vector3(Math.cos(M),0,-Math.sin(M)),o=.08;C+=i.x*e*o,H+=i.z*e*o,U-=n*o,N=t.clientX,k=t.clientY}});document.addEventListener("wheel",t=>{if(b)return;t.preventDefault();const e=t.deltaY*.03;Y+=e,Y=Math.max(15,Math.min(100,Y))},{passive:!1});function ke(){requestAnimationFrame(ke),xe++,_&&(de+=.001),(Z||V)&&ye();const t=window.smoothFactors||{drag:.25,zoom:.15,general:.12};M+=(de-M)*t.drag,oe+=(Y-oe)*t.zoom,he+=(O-he)*t.drag,ie+=(C-ie)*t.general,re+=(U-re)*t.general,se+=(H-se)*t.general;const e=new THREE.Vector3(-Math.sin(M),0,-Math.cos(M)),n=new THREE.Vector3(Math.cos(M),0,-Math.sin(M)),i=.3;if(!b&&g.leftPos){const o=g.leftPos.x/g.maxRadius,r=-g.leftPos.y/g.maxRadius;Math.abs(o)>.12&&(C+=n.x*o*i*.8,H+=n.z*o*i*.8),Math.abs(r)>.12&&(C+=e.x*r*i*.8,H+=e.z*r*i*.8)}if(v.w&&(C+=e.x*i,H+=e.z*i),v.s&&(C-=e.x*i,H-=e.z*i),v.a&&(C-=n.x*i,H-=n.z*i),v.d&&(C+=n.x*i,H+=n.z*i),v.space&&(U+=i),v.shift&&(U-=i),g.upPressed&&(U+=i*.9),g.downPressed&&(U-=i*.9),F.position.x=ie+Math.sin(M)*oe,F.position.z=se+Math.cos(M)*oe,F.position.y=re+he,F.lookAt(ie,re,se),I.update(xe),h){try{y.updateSelectedIndicatorPosition()}catch{}try{I.updateGizmoPosition(h)}catch{}}I.render()}ke();window.addEventListener("resize",()=>{I.resize(window.innerWidth,window.innerHeight)});</script>
  <style rel="stylesheet" crossorigin>*{margin:0;padding:0;box-sizing:border-box}body{width:100%;height:100vh;background:linear-gradient(to bottom,#000,#2a1a3e,#000);font-family:Orbitron;overflow:hidden;cursor:default}#canvas{width:100%;height:100%;display:block}.ui-container{position:absolute;inset:0;pointer-events:none}.message-display{position:fixed;bottom:24px;left:50%;transform:translate(-50%);z-index:50;pointer-events:none}.message{font-family:monospace;color:#0ff;font-size:12px;background:#00000080;padding:8px 12px;border:1px solid #00ffff;margin:8px 0;animation:fadeOut 5s forwards;pointer-events:auto;cursor:pointer}@keyframes fadeOut{0%{opacity:1}80%{opacity:1}to{opacity:0}}.title{position:absolute;top:24px;left:50%;transform:translate(-50%);color:#f0f;font-size:24px;font-weight:700;animation:pulse 2s infinite;pointer-events:none}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.left-panel{position:absolute;top:24px;left:24px;color:#0ff;font-size:14px;pointer-events:auto;width:256px}.panel-box{background:#000000b3;padding:10px;border:1px solid #00ffff;width:100%}.right-panel .panel-box{overflow-x:hidden}.right-panel .panel-box{max-height:calc(100vh - 80px);overflow-y:auto;padding-right:8px}.legend{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #00ffff}.legend-title{font-size:12px;color:#0cf;margin-bottom:8px}.legend-entry{display:flex;align-items:center;gap:8px;font-size:12px;margin-bottom:4px}.legend-color{width:12px;height:12px;border:1px solid rgba(255,255,255,.2);border-radius:2px}.controls-text{font-size:12px;color:#0cf;line-height:1.6}.right-panel{position:absolute;top:18px;right:18px;color:#0ff;font-size:12px;pointer-events:all;width:260px}.button{width:100%;color:#0ff;font-size:12px;background:#00000080;padding:8px 12px;border:1px solid #00ffff;margin-bottom:8px;cursor:pointer;text-align:center;transition:all .2s}.button:hover{background:#0ff3;color:#fff;border-color:#0cf}.smoothness-control{margin-top:16px;padding-top:12px;border-top:1px solid #00ffff}.smoothness-label{font-size:12px;color:#0cf;margin-bottom:8px}.slider-container{display:flex;align-items:center;gap:8px;margin-bottom:8px}.slider-container span{font-size:12px;color:#fff}input[type=range]{flex:1;height:8px;background:#001a4d;border-radius:4px;appearance:none;-webkit-appearance:none;cursor:pointer}input[type=range]::-webkit-slider-thumb{appearance:none;-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#0ff;cursor:pointer;border:1px solid #ffffff}input[type=range]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#0ff;cursor:pointer;border:1px solid #ffffff}.author-info{font-size:12px;color:#fff;text-align:center;margin-top:4px}.author-info a{color:#fff;text-decoration:none}.author-info a:hover{text-decoration:underline;color:#fff}.author-info a:visited,.author-info a:active,.author-info a:focus{color:#fff;text-decoration:none}.legend-editor{margin-top:12px;border-top:1px dashed rgba(0,255,255,.12);padding-top:8px}.legend-editor,.edit-panel{max-height:40vh;overflow-y:auto}#legendList{display:flex;flex-direction:column;gap:2px}.legend-editor .legend-row input[type=text],.legend-editor .legend-row input[type=color],.legend-editor .legend-row button{min-width:0}.legend-editor input#newLegendName{flex:1 1 auto;min-width:0;width:100%;box-sizing:border-box;padding:4px;height:28px;font-size:12px}.legend-editor input#newLegendName::placeholder{color:#fff9}.legend-editor #newLegendSwatch{flex:0 0 28px;width:28px;height:28px;padding:0;border:1px solid rgba(255,255,255,.06);box-sizing:border-box;cursor:pointer}.legend-editor button#addLegendBtn{flex:0 0 60px;min-width:60px;height:28px;padding:0 8px;box-sizing:border-box}.legend-editor .legend-row{display:grid;grid-template-columns:1fr 28px 60px;gap:8px;align-items:center;margin-bottom:2px}.legend-editor .legend-row input[type=text]{width:100%;padding:4px;height:28px;box-sizing:border-box;background:#0009;border:1px solid #00ffff;color:#0ff;font-size:12px}.legend-editor .legend-row .legend-swatch{width:28px;height:28px;padding:0;border:1px solid rgba(255,255,255,.06);background:#000;box-sizing:border-box;cursor:pointer;align-self:center}.legend-editor .legend-row button{width:100%;height:28px;padding:0 8px;box-sizing:border-box;display:inline-flex;align-items:center;justify-content:center;line-height:28px;margin:0}.legend-editor .legend-row>*{box-sizing:border-box;vertical-align:middle}.hidden-input{display:none}.ui-toggle{position:absolute;bottom:24px;left:24px;color:#0ff;font-size:12px;background:#00000080;padding:8px 12px;border:1px solid #00ffff;pointer-events:auto;display:none}.ui-toggle.visible{display:block}.mobile-controls{position:absolute;inset:0 0 18px;pointer-events:none}.stick{width:120px;height:120px;border-radius:50%;background:#0006;border:2px solid rgba(0,255,255,.12);position:absolute;pointer-events:auto;touch-action:none;display:flex;align-items:center;justify-content:center}.stick-knob{width:44px;height:44px;border-radius:50%;background:#00ffffe6;transform:translate(0)}.left-stick{left:18px;bottom:18px}.right-stick{right:18px;bottom:18px}.action-buttons{position:absolute;right:18px;bottom:150px;display:flex;flex-direction:column;gap:8px;pointer-events:auto}.action-btn{width:56px;height:40px;border-radius:8px;background:#0009;color:#0ff;border:1px solid #00ffff;font-size:18px;display:inline-flex;align-items:center;justify-content:center;touch-action:manipulation}@media(min-width:900px){.mobile-controls{display:none}}@media(max-width:899px){.ui-container .left-panel,.ui-container .right-panel,.title{display:none}.mobile-controls{display:block}}@media(min-width:900px){.button#editBtn{display:block}.edit-overlay{position:absolute;inset:0;pointer-events:none}.selected-node-indicator{width:48px;height:48px;border:2px dashed rgba(255,255,0,.9);border-radius:6px;position:absolute;transform:translate(-50%,-50%);pointer-events:none;z-index:80}.edit-panel{margin-top:6px;background:transparent;padding:4px 0 0;border:none;display:block}.edit-row{display:flex;gap:6px;align-items:center;margin:2px 0}.edit-row label{width:48px;color:#0ff;font-size:11px}.edit-row input[type=text],.edit-row input[type=number],.edit-row input[type=color]{flex:1;padding:4px;background:#0009;border:1px solid #00ffff;color:#0ff;font-size:12px}.edit-actions{display:flex;gap:6px;margin-top:8px;margin-bottom:0}.edit-panel .button,.edit-panel .button.small{margin-bottom:0}.button.small{padding:4px 6px;font-size:11px}.button.danger{border-color:#f55;color:#f88}}.mobile-menu{position:absolute;left:50%;transform:translate(-50%);bottom:18px;display:flex;gap:8px;pointer-events:auto;z-index:60}.mobile-action{z-index:70}.mobile-action{width:48px;height:48px;border-radius:10px;background:#000000b3;color:#0ff;border:1px solid #00ffff;font-size:18px;display:inline-flex;align-items:center;justify-content:center;touch-action:manipulation}@media(min-width:900px){.mobile-menu{display:none}}</style>
</head>
<body>
	<div id="canvas"></div>
	<div class="ui-container">
		<div class="title" id="title">ARCHITECTURE VISUALIZATION</div>
		<div class="left-panel" id="leftPanel">
			<div class="panel-box">
				<div class="legend" id="legendContainer" style="display: none;">
					<div class="legend-title">LEGEND:</div>
					<div id="legendItems"></div>
				</div>
				<div class="controls-text">
					ORBIT MODE<br>
					LEFT DRAG - ROTATE VIEW<br>
					RIGHT/MIDDLE DRAG - PAN<br>
					SCROLL - ZOOM<br>
					WASD - MOVE CAMERA<br>
					SPACE/SHIFT - UP/DOWN<br>
					AUTO-ROTATES AFTER 3s
					<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #00ffff;">
						<span style="color: #ffff00;">U</span> - TOGGLE UI<br>
						<span style="color: #ffff00;">Q</span> - TOGGLE CURSOR
					</div>
					<div class="author-info">© <a href="https://github.com/cziter15" target="_blank">K. STREHLAU</a></div>
				</div>
			</div>
		</div>
		<div class="right-panel" id="rightPanel">
			<div class="panel-box">
				<button class="button" id="saveBtn">💾 SAVE</button>
				<button class="button" id="loadBtn">📁 LOAD</button>
				<button class="button" id="sampleBtn">📋 LOAD SAMPLE</button>
				<button class="button" id="editBtn">✏️ EDIT</button>
				<div class="smoothness-control">
					<div class="smoothness-label">CAMERA SMOOTHNESS:</div>
					<div class="slider-container">
						<span>MIN</span>
						<input type="range" id="smoothnessSlider" min="0.05" max="0.5" step="0.05" value="0.15">
						<span>MAX</span>
					</div>
				</div>

				<!-- Legend editor (always visible) -->
				<div class="legend-editor" id="legendEditor" style="margin-top:12px;">
					<div style="margin-bottom:8px;">
						<div class="legend-title" style="font-size:12px;color:#00ccff;">LEGEND EDITOR</div>
					</div>
					<div id="legendList"></div>
					<div class="legend-row" style="margin-top:8px;">
						<input type="text" id="newLegendName" placeholder="Name" />
						<div id="newLegendSwatch" style="width:28px;height:28px;border:1px solid #00ffff;background:#00ffff;cursor:pointer;"></div>
						<button class="button small" id="addLegendBtn">ADD</button>
					</div>
				</div>
	
				<div style="border-top:1px dashed rgba(0,255,255,0.12);margin-top:8px;padding-top:4px;">
					<div id="nodeEditorHeader" style="font-size:12px;color:#00ccff;margin:4px 0 6px 0;">NODE EDITOR</div>
				</div>

				<!-- Edit panel (desktop only) -->
				<div class="edit-panel" id="editPanel" aria-hidden="true" style="display:none;">
					<div id="editContent">
						<div class="edit-row"><label>Name</label><input type="text" id="editName"></div>
						<!-- Color removed: node color is derived from legend category -->
						<!-- EDIT LEGEND button removed from node editor (legend editor has its own controls) -->
						<div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
							<select id="assignLegendSelect" style="flex:1;padding:6px;background:rgba(0,0,0,0.6);border:1px solid #00ffff;color:#00ffff;"></select>
						</div>
						<div class="edit-row"><label>Scale</label><input type="number" id="editScale" step="0.1" min="0.1"></div>
						<div class="edit-row"><label>Pos X</label><input type="number" id="editPosX" step="0.1"></div>
						<div class="edit-row"><label>Pos Y</label><input type="number" id="editPosY" step="0.1"></div>
						<div class="edit-row"><label>Pos Z</label><input type="number" id="editPosZ" step="0.1"></div>
						<div class="edit-actions">
							<button class="button small" id="addChildBtn">+ CHILD</button>
							<button class="button small danger" id="deleteNodeBtn">DELETE</button>
						</div>
					</div>
					</div>
                
			</div>
		</div>
		<div class="message-display" id="messageDisplay"></div>
		<div class="ui-toggle" id="uiToggle">Press U to show UI</div>
	</div>
	<!-- Mobile controls -->
	<div id="mobileControls" class="mobile-controls" aria-hidden="true">
		<div id="leftStick" class="stick left-stick" aria-label="move joystick">
			<div class="stick-knob"></div>
		</div>
		<div id="rightStick" class="stick right-stick" aria-label="look joystick">
			<div class="stick-knob"></div>
		</div>
		<div class="action-buttons">
			<button id="btnUp" class="action-btn">▲</button>
			<button id="btnDown" class="action-btn">▼</button>
		</div>
	</div>

	<!-- Mobile menu: quick actions for small screens -->
	<div class="mobile-menu" id="mobileMenu">
		<button id="mobileSaveBtn" class="mobile-action">💾</button>
		<button id="mobileLoadBtn" class="mobile-action">📁</button>
		<button id="mobileSampleBtn" class="mobile-action">📋</button>
	</div>
	<input type="file" id="xmlFileInput" class="hidden-input" accept=".xml">
</body>
</html>
