<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Reduce aggressive caching during development / debugging on mobile devices -->
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>ArchVis WebGL</title>
	<link rel="icon" href="./cog.svg" type="image/svg+xml">
	<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script type="module" crossorigin>(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();class Ee{static architectureToXML(t){let n=`<?xml version="1.0" encoding="UTF-8"?>
`;n+=`<arch>
`;const o=[];return o.push(`name="${t.root.name}"`),o.push(`pos="${t.root.pos.join(",")}"`),t.root.id&&o.push(`id="${t.root.id}"`),t.root.category?o.push(`category="${t.root.category}"`):t.root.color&&o.push(`color="${t.root.color}"`),t.root.scale!==void 0&&o.push(`scale="${t.root.scale}"`),n+=`  <node ${o.join(" ")}>
`,t.root.children.forEach(i=>{n+=this.nodeToXML(i,2)}),n+=`  </node>
`,t.legend&&t.legend.length>0&&(n+=`  <legend>
`,t.legend.forEach(i=>{n+=`    <entry id="${i.id||""}" name="${i.name}" color="${i.color}" />
`}),n+=`  </legend>
`),t.uiInfo&&t.uiInfo.title&&(n+=`  <ui-info>
`,n+=`    <title>${t.uiInfo.title}</title>
`,n+=`  </ui-info>
`),n+="</arch>",n}static nodeToXML(t,n){let o="";const i=" ".repeat(n),s=[];return s.push(`name="${t.name}"`),s.push(`pos="${t.pos.join(",")}"`),t.id&&s.push(`id="${t.id}"`),t.category?s.push(`category="${t.category}"`):t.color&&s.push(`color="${t.color}"`),t.scale!==void 0&&s.push(`scale="${t.scale}"`),o+=`${i}<node ${s.join(" ")}`,t.children&&t.children.length>0?(o+=`>
`,t.children.forEach(a=>{o+=this.nodeToXML(a,n+2)}),o+=`${i}</node>
`):o+=` />
`,o}static xmlToArchitecture(t){const o=new DOMParser().parseFromString(t,"text/xml"),i=o.querySelector("arch > node");if(!i)throw new Error("Root element not found in XML");const s={id:i.getAttribute("id")||Math.random().toString(36).slice(2,9),name:i.getAttribute("name"),pos:i.getAttribute("pos").split(",").map(Number),children:[]},a=i.getAttribute("category");if(a)s.category=a;else{const g=i.getAttribute("color");g&&(s.color=g)}const c=i.getAttribute("scale");c&&(s.scale=parseFloat(c)),i.querySelectorAll(":scope > node").forEach(g=>{const b=this.parseNode(g);s.children.push(b)});const u=[],m=o.querySelector("arch > legend");m&&m.querySelectorAll("entry").forEach(b=>{const M={id:b.getAttribute("id")||Math.random().toString(36).slice(2,9),name:b.getAttribute("name"),color:b.getAttribute("color")};u.push(M)});const p={title:""},h=o.querySelector("arch > ui-info");if(h){const g=h.querySelector("title");g&&(p.title=g.textContent||"")}return{root:s,legend:u,uiInfo:p}}static parseNode(t){const n={id:t.getAttribute("id")||Math.random().toString(36).slice(2,9),name:t.getAttribute("name"),pos:t.getAttribute("pos").split(",").map(Number),children:[]},o=t.getAttribute("scale");o&&(n.scale=parseFloat(o));const i=t.getAttribute("category");if(i)n.category=i;else{const a=t.getAttribute("color");a&&(n.color=a)}return t.querySelectorAll(":scope > node").forEach(a=>{const c=this.parseNode(a);n.children.push(c)}),n}}let r={root:{name:"Empty Architecture",pos:[0,0,0],color:"#666666",scale:1,children:[]},legend:[],uiInfo:{title:""}},te=!0,re=!0;if("serviceWorker"in navigator)try{navigator.serviceWorker.getRegistrations().then(e=>{e&&e.length&&console.info("Found",e.length,"service worker registrations — attempting to unregister them to avoid stale cache."),e.forEach(t=>t.unregister().then(n=>{console.info("Service worker unregistered:",n,t)}).catch(n=>console.warn("SW unregister error",n)))}).catch(e=>console.warn("Error getting SW registrations",e)),window.caches&&typeof window.caches.keys=="function"&&caches.keys().then(e=>{e.forEach(t=>{caches.delete(t).then(n=>{console.info("Cache deleted:",t,n)}).catch(n=>console.warn("Cache delete failed",t,n))})}).catch(e=>console.warn("Error listing caches",e))}catch(e){console.warn("Service worker cleanup failed",e)}window.smoothFactors||(window.smoothFactors={drag:.25,zoom:.15,general:.12});function w(e){const t=document.getElementById("messageDisplay"),n=document.createElement("div");n.className="message",n.textContent=e,t.appendChild(n),setTimeout(()=>n.remove(),5e3)}function O(){const e=document.getElementById("legendContainer"),t=document.getElementById("legendItems");r.legend&&r.legend.length>0?(e.style.display="block",t.innerHTML="",r.legend.forEach(n=>{const o=document.createElement("div");o.className="legend-entry",o.innerHTML=`
						<div class="legend-color" style="background-color: ${n.color};"></div>
						<span style="color: white;">${n.name}</span>
					`,t.appendChild(o)})):e.style.display="none",k();try{ie()}catch{}}function it(){const e=document.getElementById("legendItems"),t=document.getElementById("legendContainer");r.legend&&r.legend.length>0?(t&&(t.style.display="block"),e&&(e.innerHTML="",r.legend.forEach(n=>{const o=document.createElement("div");o.className="legend-entry",o.innerHTML=`
						<div class="legend-color" style="background-color: ${n.color};"></div>
						<span style="color: white;">${n.name}</span>
					`,e.appendChild(o)}))):t&&(t.style.display="none"),k()}function ke(){const e=document.getElementById("title");e.textContent=r.uiInfo?.title||"ARCHITECTURE VISUALIZATION"}document.getElementById("saveBtn").addEventListener("click",()=>{if(r.root.name==="Empty Architecture"||!r.root.name){w("No architecture to save. Please load an architecture first.");return}const e=Ee.architectureToXML(r),t=new Blob([e],{type:"application/xml"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download="architecture.xml",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),w("Architecture saved successfully!")});document.getElementById("loadBtn").addEventListener("click",()=>{document.getElementById("xmlFileInput").click()});document.getElementById("xmlFileInput").addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=o=>{try{let c=function(d,u){if(d){if(!d.category&&d.color&&u&&u.length){const m=u.find(p=>p.color&&p.color.toLowerCase()===d.color.toLowerCase());m&&(d.category=m.id,delete d.color)}d.children&&d.children.forEach(m=>c(m,u))}};var i=c;const s=o.target.result;if(!s||s.trim()==="")throw new Error("Empty file");const a=Ee.xmlToArchitecture(s);if(!a||!a.root)throw new Error("Invalid architecture structure");r={root:a.root||{name:"Unknown Root",pos:[0,0,0],color:"#ff00ff",scale:1,children:[]},legend:a.legend||[],uiInfo:a.uiInfo||{title:""}},c(r.root,r.legend),me(r.root),O(),ke(),T(),w("Architecture loaded successfully!")}catch(s){w("Error loading XML file: "+s.message)}},n.readAsText(t),e.target.value=""});document.getElementById("sampleBtn").addEventListener("click",()=>{const e=`<?xml version="1.0" encoding="UTF-8"?>
<arch>
  <node name="ROOT" pos="0,0,0" color="#00ffff" scale="1">
	<node name="API Gateway" pos="10,5,0" color="#ff00ff" scale="0.8">
	  <node name="Auth Service" pos="15,8,5" color="#ffff00" scale="0.6" />
	  <node name="Rate Limiter" pos="15,8,-5" color="#ffff00" scale="0.6" />
	</node>
	<node name="Database Layer" pos="-10,5,0" color="#00ff00" scale="0.8">
	  <node name="Primary DB" pos="-15,8,5" color="#ffff00" scale="0.6" />
	  <node name="Cache" pos="-15,8,-5" color="#ffff00" scale="0.6" />
	</node>
	<node name="Workers" pos="0,-5,10" color="#ff6600" scale="0.8">
	  <node name="Job Queue" pos="5,-8,15" color="#ffff00" scale="0.6" />
	  <node name="Worker Pool" pos="-5,-8,15" color="#ffff00" scale="0.6" />
	</node>
  </node>
  <legend>
	<entry name="Core Services" color="#00ffff" />
	<entry name="Modules" color="#ff00ff" />
	<entry name="Components" color="#ffff00" />
	<entry name="Data Layer" color="#00ff00" />
  </legend>
  <ui-info>
	<title>MICROSERVICES ARCHITECTURE</title>
  </ui-info>
</arch>`;try{let o=function(i,s){if(i){if(!i.category&&i.color&&s&&s.length){const a=s.find(c=>c.color&&c.color.toLowerCase()===i.color.toLowerCase());a&&(i.category=a.id,delete i.color)}i.children&&i.children.forEach(a=>o(a,s))}};var t=o;r=Ee.xmlToArchitecture(e),o(r.root,r.legend),me(r.root),O(),ke(),T(),w("Sample architecture loaded successfully!")}catch(n){w("Error loading sample: "+n.message)}});const be=document.getElementById("mobileSaveBtn"),Le=document.getElementById("mobileLoadBtn"),Ie=document.getElementById("mobileSampleBtn");be&&be.addEventListener("click",()=>document.getElementById("saveBtn").click());Le&&Le.addEventListener("click",()=>document.getElementById("xmlFileInput").click());Ie&&Ie.addEventListener("click",()=>document.getElementById("sampleBtn").click());document.getElementById("smoothnessSlider").addEventListener("change",e=>{const n=.55-parseFloat(e.target.value);window.smoothFactors={drag:n,zoom:n*.8,general:n*1.2};const o=Math.round((.55-n)/.45*100);w(`Smoothness set to ${o}%`)});document.addEventListener("keydown",e=>{e.key.toLowerCase()==="u"&&(te=!te,document.getElementById("rightPanel").style.display=te?"block":"none",document.getElementById("leftPanel").style.display=te?"block":"none",document.getElementById("uiToggle").classList.toggle("visible",!te)),e.key.toLowerCase()==="q"&&(re=!re,document.body.style.cursor=re?"default":"none",w(`Cursor ${re?"visible":"hidden"}`))});const B=new THREE.Scene;B.fog=new THREE.FogExp2(1296,.008);const I=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,1e3);I.position.set(0,15,50);I.lookAt(0,0,0);const U=new THREE.WebGLRenderer({antialias:!0,alpha:!0});U.setSize(window.innerWidth,window.innerHeight);U.setClearColor(1296);document.getElementById("canvas").appendChild(U.domElement);const rt=new THREE.AmbientLight(1710654,.8);B.add(rt);const Pe=new THREE.PointLight(65535,1.5,60);Pe.position.set(15,15,15);B.add(Pe);const Ae=new THREE.PointLight(16711935,1.5,60);Ae.position.set(-15,10,-15);B.add(Ae);const Ne=new THREE.PointLight(16777215,1,40);Ne.position.set(0,20,0);B.add(Ne);const Xe=new THREE.GridHelper(100,100,65535,657966);Xe.position.y=-18;B.add(Xe);const q=[],de=[];function st(e,t){const n=document.createElement("canvas"),o=n.getContext("2d");n.width=1024,n.height=128,o.clearRect(0,0,n.width,n.height),o.font="54px Orbitron, sans-serif",o.textAlign="center",o.textBaseline="middle",o.shadowColor=t,o.shadowBlur=15,o.fillStyle=t,o.fillText(e.toUpperCase(),n.width/2,n.height/2);const i=new THREE.CanvasTexture(n);i.needsUpdate=!0;const s=new THREE.PlaneGeometry(4.5,.56),a=new THREE.MeshBasicMaterial({map:i,transparent:!0,side:THREE.DoubleSide,depthTest:!0}),c=new THREE.Mesh(s,a),d=new THREE.PlaneGeometry(4.6,.66),u=new THREE.MeshBasicMaterial({color:1296,transparent:!0,opacity:.8,side:THREE.DoubleSide}),m=new THREE.Mesh(d,u);m.position.z=-.05;const p=new THREE.Group;p.add(m),p.add(c);const h=new THREE.EdgesGeometry(new THREE.PlaneGeometry(4.6,.66)),g=new THREE.LineBasicMaterial({color:t,linewidth:2}),b=new THREE.LineSegments(h,g);return p.add(b),p}function ze(e,t,n,o=1,i=null){const s=new THREE.Group,a=new THREE.Group,c=new THREE.BoxGeometry(.6*o,.6*o,.6*o),d=new THREE.EdgesGeometry(c),u=new THREE.LineBasicMaterial({color:n,linewidth:2}),m=new THREE.LineSegments(d,u);a.add(m);const p=new THREE.BoxGeometry(.4*o,.4*o,.4*o),h=new THREE.MeshBasicMaterial({color:n,transparent:!0,opacity:.3,wireframe:!0}),g=new THREE.Mesh(p,h);a.add(g);const b=new THREE.PointLight(n,.5,5);a.add(b),s.add(a);try{const P=st(e,n);P.position.y=1.5*o,s.add(P)}catch(P){console.warn("Failed to create text mesh:",P)}s.position.set(...t);const M=i||Math.random().toString(36).slice(2,9);return s.userData={id:M,name:e,rotationSpeed:Math.random()*.01+.005,rotatingGroup:a},B.add(s),q.push(s),s}function Be(e){return q.find(t=>t.userData&&t.userData.id===e)||null}function at(e,t,n,o=null,i=null,s=.5){const a=[new THREE.Vector3(...e),new THREE.Vector3(...t)],c=new THREE.BufferGeometry().setFromPoints(a),d=new THREE.LineBasicMaterial({color:n,transparent:!0,opacity:s}),u=new THREE.Line(c,d);return u.userData={startId:o,endId:i},B.add(u),de.push(u),u}function Fe(e,t,n,o){e.forEach(i=>{if(i.name){const s=Ye(i),a=ze(i.name,i.pos,s,i.scale||1,i.id||null),c=t&&t.userData?t.userData.id:null;at(n,i.pos,o,c,i.id||null),i.children&&i.children.length>0&&Fe(i.children,a,i.pos,s)}})}function Ge(e,t){if(!(!e||!t))try{const n=e.userData&&e.userData.rotatingGroup;n&&n.children&&n.children.forEach(o=>{o.material&&o.material.color&&o.material.color.set(t),(o.isPointLight||o.type==="PointLight")&&o.color&&o.color.set&&o.color.set(t)}),e.children.forEach(o=>{o.type==="Group"&&o.children.forEach(i=>{i.material&&i.material.color&&i.material.color.set(t)})})}catch(n){console.warn("Failed to update scene node color",n)}}function Ye(e){if(!e)return"#666666";if(e.category){const t=(r.legend||[]).find(n=>n.id===e.category||n.name===e.category);if(t&&t.color)return t.color}return e.color?e.color:"#666666"}function T(){const e=l&&l.userData?l.userData.id:null;if(q.forEach(t=>B.remove(t)),de.forEach(t=>B.remove(t)),q.length=0,de.length=0,r.root.name&&r.root.name!=="Empty Architecture"){r.root.id||(r.root.id=Math.random().toString(36).slice(2,9));const t=Ye(r.root),n=ze(r.root.name,r.root.pos,t,r.root.scale,r.root.id);r.root.children&&r.root.children.length>0&&Fe(r.root.children,n,r.root.pos,t)}if(e){const t=q.find(n=>n.userData&&n.userData.id===e);t?(l=t,L&&(L.style.display="block"),oe(),j()):(l=null,L&&(L.style.display="none"),j())}}const $e=new THREE.BufferGeometry,Oe=1500,qe=new Float32Array(Oe*3);for(let e=0;e<Oe*3;e++)qe[e]=(Math.random()-.5)*100;$e.setAttribute("position",new THREE.BufferAttribute(qe,3));const lt=new THREE.PointsMaterial({size:.05,color:65535,transparent:!0,opacity:.6}),ye=new THREE.Points($e,lt);B.add(ye);const x={w:!1,a:!1,s:!1,d:!1,shift:!1,space:!1},f={leftTouchId:null,rightTouchId:null,leftStart:null,rightStart:null,leftPos:{x:0,y:0},rightPos:{},maxRadius:44};f.upPressed=!1;f.downPressed=!1;let C=0,ue=0,se=50,Z=50,pe=15,V=15,ae=0,z=0,le=0,K=0,ce=0,F=0,Q=!1,ee=!1,G=0,Y=0,W=!0,ge,Te=0,E=!1,l=null,L=null,y=null;const _=new THREE.Raycaster,S=new THREE.Vector2;let v=null,D=null;function fe(){clearTimeout(ge);const e=()=>{E?ge=setTimeout(e,1e3):W=!0};ge=setTimeout(e,3e3)}document.addEventListener("keydown",e=>{const t=e.key.toLowerCase();t==="w"&&(x.w=!0),t==="a"&&(x.a=!0),t==="s"&&(x.s=!0),t==="d"&&(x.d=!0),e.key==="Shift"&&(x.shift=!0),e.key===" "&&(x.space=!0),e.key==="Escape"&&document.pointerLockElement===document.getElementById("canvas")&&document.exitPointerLock()});document.addEventListener("keyup",e=>{const t=e.key.toLowerCase();t==="w"&&(x.w=!1),t==="a"&&(x.a=!1),t==="s"&&(x.s=!1),t==="d"&&(x.d=!1),e.key==="Shift"&&(x.shift=!1),e.key===" "&&(x.space=!1)});document.addEventListener("mousedown",e=>{if(E){if(e.button===0&&(Q=!0,G=e.clientX,Y=e.clientY,W=!1),e.button===1||e.button===2){e.preventDefault(),ee=!0,G=e.clientX,Y=e.clientY,W=!1;return}return}e.button===0?(Q=!0,G=e.clientX,Y=e.clientY,W=!1):(e.button===1||e.button===2)&&(e.preventDefault(),ee=!0,G=e.clientX,Y=e.clientY,W=!1)});document.addEventListener("mouseup",()=>{Q=!1,ee=!1});function ct(){return window.innerWidth>=900}function je(){L||(L=document.createElement("div"),L.className="selected-node-indicator",document.body.appendChild(L))}function dt(){y||(y=document.createElement("input"),y.type="text",y.style.position="absolute",y.style.zIndex=90,y.style.display="none",y.style.padding="6px 8px",y.style.border="1px solid #00ffff",y.style.background="rgba(0,0,0,0.8)",y.style.color="#00ffff",y.style.fontFamily="Orbitron, sans-serif",document.body.appendChild(y),y.addEventListener("blur",()=>{if(!l)return;const e=y.value.trim();e&&e!==l.userData.name&&(l.userData.name=e,gt(e),T()),y.style.display="none"}))}function ut(){if(v)return v;v=new THREE.Group;const e=new THREE.CylinderGeometry(.06,.06,1,8),t=new THREE.ConeGeometry(.12,.2,8),n=new THREE.MeshBasicMaterial({color:16711680}),o=new THREE.Mesh(e,n);o.rotation.z=-Math.PI/2,o.position.x=.5;const i=new THREE.Mesh(t,n);i.rotation.z=-Math.PI/2,i.position.x=1.05;const s=new THREE.Group;s.add(o),s.add(i),s.userData={axis:"x"};const a=new THREE.MeshBasicMaterial({color:65280}),c=new THREE.Mesh(e,a);c.position.y=.5;const d=new THREE.Mesh(t,a);d.position.y=1.05;const u=new THREE.Group;u.add(c),u.add(d),u.userData={axis:"y"};const m=new THREE.MeshBasicMaterial({color:255}),p=new THREE.Mesh(e,m);p.rotation.x=Math.PI/2,p.position.z=.5;const h=new THREE.Mesh(t,m);h.rotation.x=Math.PI/2,h.position.z=1.05;const g=new THREE.Group;return g.add(p),g.add(h),g.userData={axis:"z"},v.add(s,u,g),v.visible=!1,B.add(v),v}function ft(e){e&&(ut(),v.position.copy(e.position),v.visible=!0)}function mt(){v&&(v.visible=!1)}function we(){!v||!l||v.position.copy(l.position)}function oe(){if(!l||!L)return;const t=l.position.clone().project(I),n=(t.x*.5+.5)*window.innerWidth,o=(-t.y*.5+.5)*window.innerHeight;L.style.left=n+"px",L.style.top=o+"px"}function Ue(){if(!l||!y)return;const t=l.position.clone().project(I),n=(t.x*.5+.5)*window.innerWidth,o=(-t.y*.5+.5)*window.innerHeight;y.style.left=n+24+"px",y.style.top=o-12+"px",y.value=l.userData.name||"",y.style.display="block",y.focus()}function pt(){if(!l)return;const e=l.userData&&l.userData.id;if(!e)return;const t=X(r.root,e);t?t.pos=[l.position.x,l.position.y,l.position.z]:r.root&&r.root.id===e&&(r.root.pos=[l.position.x,l.position.y,l.position.z]),T()}function gt(e){if(!l)return;const t=l.userData.name;function n(o){if(o.name===t)return o.name=e,!0;if(o.children){for(const i of o.children)if(n(i))return!0}return!1}if(r.root&&r.root.name){if(r.root.name===t){r.root.name=e;return}n(r.root)}}function X(e,t){if(!e)return null;if(e.id&&e.id===t)return e;if(e.children)for(const n of e.children){const o=X(n,t);if(o)return o}return null}function me(e){e&&(e.id||(e.id=Math.random().toString(36).slice(2,9)),e.children&&e.children.forEach(me))}function j(){const e=document.getElementById("editPanel");if(!e)return;if(!E){e.style.display="none",e.setAttribute("aria-hidden","true");return}const t=document.getElementById("editContent");if(!l){e.style.display="block",e.setAttribute("aria-hidden","false"),t&&(t.innerHTML='<div style="color:#00ffff;font-size:12px;padding:6px;">Select a node to edit it</div>');return}const n=X(r.root,l.userData.id)||(r.root.name===l.userData.name?r.root:null),o=!n&&(r.root.name===l.userData.name?r.root:null);e.style.display="block",e.setAttribute("aria-hidden","false");const i=document.getElementById("editName"),s=document.getElementById("editScale"),a=document.getElementById("editPosX"),c=document.getElementById("editPosY"),d=document.getElementById("editPosZ"),u=n||o?n||o:null;if(u){const p=document.getElementById("editContent");if(p&&p.querySelector("#editName")==null){p.innerHTML=`
				<div class="edit-row"><label>Name</label><input type="text" id="editName"></div>
				<div style="display:flex;gap:8px;margin-top:8px;align-items:center;"><select id="assignLegendSelect" style="flex:1;padding:6px;background:rgba(0,0,0,0.6);border:1px solid #00ffff;color:#00ffff;"></select></div>
				<div class="edit-row"><label>Scale</label><input type="number" id="editScale" step="0.1" min="0.1"></div>
				<div class="edit-row"><label>Pos X</label><input type="number" id="editPosX" step="0.1"></div>
				<div class="edit-row"><label>Pos Y</label><input type="number" id="editPosY" step="0.1"></div>
				<div class="edit-row"><label>Pos Z</label><input type="number" id="editPosZ" step="0.1"></div>
				<div class="edit-actions"><button class="button small" id="addChildBtn">+ CHILD</button><button class="button small danger" id="deleteNodeBtn">DELETE</button></div>
			`;try{We()}catch{}}const h=document.getElementById("editName"),g=document.getElementById("editScale"),b=document.getElementById("editPosX"),M=document.getElementById("editPosY"),P=document.getElementById("editPosZ");h&&(h.value=u.name||l.userData.name||""),g&&(g.value=u.scale||1),b&&(b.value=(l.position.x||0).toFixed(2)),M&&(M.value=(l.position.y||0).toFixed(2)),P&&(P.value=(l.position.z||0).toFixed(2))}else i&&(i.value=l.userData.name||""),s&&(s.value=1),a&&(a.value=(l.position.x||0).toFixed(2)),c&&(c.value=(l.position.y||0).toFixed(2)),d&&(d.value=(l.position.z||0).toFixed(2));k();const m=document.getElementById("assignLegendSelect");if(m){const p=X(r.root,l.userData.id);let h="";if(p&&p.category&&(h=p.category),h!==""){const g=parseInt(h,10);if(!isNaN(g)&&r.legend&&r.legend[g])h=r.legend[g].id;else if(!(r.legend||[]).find(M=>M.id===h)){const M=(r.legend||[]).find(P=>P.name===h);M?h=M.id:h=""}}m.value=h||""}}let Me=!1;function ie(){const e=document.getElementById("legendList");if(!e)return;e.innerHTML="",(r.legend||[]).forEach((n,o)=>{const i=document.createElement("div");i.className="legend-row",E||Me?i.innerHTML=`
				<input type="text" class="legend-name" data-idx="${o}" value="${n.name}" />
				<div class="legend-swatch" data-idx="${o}" title="Click to change color" style="width:28px;height:28px;border:1px solid #00ffff;background:${n.color};box-sizing:border-box;cursor:pointer;"></div>
				<button class="button small legend-remove" data-idx="${o}">DEL</button>
			`:i.innerHTML=`
				<div style="flex:1;color:#00ffff;">${n.name}</div>
				<div style="width:12px;height:12px;background:${n.color};border:1px solid rgba(255,255,255,0.1);"></div>
			`,e.appendChild(i)}),(E||Me)&&(e.querySelectorAll(".legend-name").forEach(n=>{n.addEventListener("change",o=>{const i=parseInt(o.target.dataset.idx,10);r.legend[i]&&(r.legend[i].name=o.target.value,O())})}),e.querySelectorAll(".legend-swatch").forEach(n=>{n.addEventListener("click",o=>{const i=parseInt(n.dataset.idx,10);if(isNaN(i)||!r.legend[i])return;const s=r.legend[i].color||"#00ffff";ve(n,s,a=>{r.legend[i].color=a,O(),T()})})}),e.querySelectorAll(".legend-remove").forEach(n=>{n.addEventListener("click",o=>{const i=parseInt(o.target.dataset.idx,10);i>=0&&i<r.legend.length&&(r.legend.splice(i,1),O(),ie(),k())})}))}function ve(e,t,n){try{const o=e.getBoundingClientRect(),i=document.createElement("input");i.type="color",i.value=t||"#00ffff",i.style.position="absolute",i.style.left=o.left+window.scrollX+"px",i.style.top=o.top+window.scrollY+"px",i.style.width=o.width+"px",i.style.height=o.height+"px",i.style.zIndex=1e5,i.style.border="none",i.style.padding="0",i.style.margin="0",i.style.background="transparent",i.style.opacity="0.01",document.body.appendChild(i);let s=!1;const a=()=>{if(!s){s=!0;try{i.remove()}catch{}try{document.removeEventListener("mousedown",d,!0)}catch{}try{clearTimeout(u)}catch{}}},c=m=>{try{n&&n(m)}catch(p){console.warn("onPick handler error",p)}};i.addEventListener("input",m=>{c(m.target.value)}),i.addEventListener("change",m=>{c(m.target.value),a()}),i.addEventListener("blur",()=>{setTimeout(a,200)});const d=m=>{i.contains(m.target)||a()};document.addEventListener("mousedown",d,!0);const u=setTimeout(()=>{a()},6e3);i.click()}catch(o){console.warn("color picker fallback",o)}}const Se=document.getElementById("addLegendBtn");Se&&Se.addEventListener("click",()=>{const e=document.getElementById("newLegendName"),t=document.getElementById("newLegendSwatch");if(!e||!t)return;const n=e.value.trim(),o=t.style.backgroundColor||"#00ffff";if(!n){w("Legend name required");return}r.legend||(r.legend=[]);const i={id:Math.random().toString(36).slice(2,9),name:n,color:o};r.legend.push(i),e.value="",t.style.backgroundColor="#00ffff",O(),ie(),k(),w("Legend added")});const ne=document.getElementById("newLegendSwatch");ne&&ne.addEventListener("click",()=>{const e=ne.style.backgroundColor||"#00ffff";ve(ne,e,t=>{ne.style.backgroundColor=t})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("legendList");e&&(e.addEventListener("click",t=>{const n=t.target;if(n.classList&&n.classList.contains("legend-swatch")){const o=parseInt(n.dataset.idx,10);if(isNaN(o)||!r.legend[o])return;const i=r.legend[o].color||"#00ffff";ve(n,i,s=>{r.legend[o].color=s,O(),T()});return}if(n.classList&&n.classList.contains("legend-remove")){const o=parseInt(n.dataset.idx,10);!isNaN(o)&&o>=0&&o<r.legend.length&&(r.legend.splice(o,1),O(),k());return}},!0),e.addEventListener("input",t=>{const n=t.target;if(n.classList&&n.classList.contains("legend-name")){const o=parseInt(n.dataset.idx,10);!isNaN(o)&&r.legend[o]&&(r.legend[o].name=n.value,it())}},!0))});function k(){const e=document.getElementById("assignLegendSelect");if(!e)return;e.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="-- none --",e.appendChild(t),(r.legend||[]).forEach(n=>{const o=document.createElement("option");o.value=n.id||n.name,o.textContent=n.name,e.appendChild(o)})}const he=document.getElementById("assignLegendSelect");he&&he.addEventListener("change",()=>{if(!l)return;const e=he,t=e.value===""?"":e.value,n=X(r.root,l.userData.id);if(n){if(!t)delete n.category;else{n.category=t;const o=r.legend.find(i=>i.id===t);o&&Ge(l,o.color)}T(),k(),j()}});document.addEventListener("DOMContentLoaded",()=>{k();const e=document.getElementById("legendEditor");e&&(e.style.display=E?"":"none");const t=document.getElementById("editPanel");t&&(t.style.display=E?"":"none",t.setAttribute("aria-hidden",E?"false":"true"));const n=document.getElementById("nodeEditorHeader");n&&(n.style.display=E?"":"none");try{ie()}catch{}});function We(){const e=document.getElementById("editName"),t=document.getElementById("editScale"),n=document.getElementById("editPosX"),o=document.getElementById("editPosY"),i=document.getElementById("editPosZ"),s=()=>{if(!l)return;const a=e.value.trim(),c=parseFloat(t.value)||1,d=parseFloat(n.value)||0,u=parseFloat(o.value)||0,m=parseFloat(i.value)||0;l.userData.name=a,l.position.set(d,u,m);const p=X(r.root,l.userData.id);p?(p.name=a,p.scale=c,p.pos=[d,u,m]):r.root&&r.root.name===l.userData.name&&(r.root.name=a,r.root.scale=c,r.root.pos=[d,u,m]),oe(),we(),T()};e&&e.addEventListener("change",s),t&&t.addEventListener("change",s),n&&n.addEventListener("change",s),o&&o.addEventListener("change",s),i&&i.addEventListener("change",s)}try{We()}catch{}function Ze(){if(!E){w("Enter Edit mode to add nodes.");return}if(!r.root||!r.root.name||r.root.name==="Empty Architecture"){r.root={id:Math.random().toString(36).slice(2,9),name:"ROOT",pos:[0,0,0],color:"#00ffff",scale:1,children:[]},me(r.root),T(),w("Root node created");return}const e=l||null,t={id:Math.random().toString(36).slice(2,9),name:"New Node",pos:e?[e.position.x+5,e.position.y,e.position.z]:[r.root.pos[0]+5,r.root.pos[1],r.root.pos[2]],scale:.6,children:[]};if(e){const n=X(r.root,e.userData.id)||(r.root.name===e.userData.name?r.root:null);n?(n.children||(n.children=[]),n.children.push(t)):(r.root.children||(r.root.children=[]),r.root.children.push(t))}else r.root.children||(r.root.children=[]),r.root.children.push(t);T(),w("Child node added")}const Re=document.getElementById("addChildBtn");Re&&Re.addEventListener("click",Ze);function Ve(){if(!l)return;const e=l.userData.id;function t(n){if(!n||!n.children)return!1;const o=n.children.findIndex(i=>i.id===e);if(o!==-1)return n.children.splice(o,1),!0;for(const i of n.children)if(t(i))return!0;return!1}if(r.root.id===e){w("Cannot delete root node");return}if(!t(r.root)){w("Failed to delete node (mapping not found)");return}l=null,T(),w("Node deleted")}const He=document.getElementById("deleteNodeBtn");He&&He.addEventListener("click",Ve);document.addEventListener("click",e=>{if(e.target.closest&&e.target.closest("#addChildBtn")){e.preventDefault(),Ze();return}if(e.target.closest&&e.target.closest("#deleteNodeBtn")){e.preventDefault(),Ve();return}});document.addEventListener("change",e=>{if(!e.target||e.target.id!=="assignLegendSelect"||!l)return;const t=e.target,n=t.value===""?"":t.value,o=X(r.root,l.userData.id);if(o){if(!n)delete o.category;else{o.category=n;const i=r.legend.find(s=>s.id===n);i&&Ge(l,i.color)}T(),k(),j()}});function _e(){const e=(t,n,o)=>{const i=document.getElementById(t);i&&(i.dataset&&i.dataset.wired||(i.addEventListener(n,o),i.dataset.wired="1"))};e("editBtn","click",()=>{if(!ct()){w("Edit mode is available on desktop only.");return}E=!E;const t=document.getElementById("editBtn");if(t&&(t.classList.toggle("active",E),t.textContent=E?"✖️ EXIT EDITOR":"✏️ EDIT"),E){ie(),k();const n=document.getElementById("nodeEditorHeader");n&&(n.style.display="");const o=document.getElementById("editPanel");o&&(o.style.display="",o.setAttribute("aria-hidden","false")),je(),dt(),W=!1,["saveBtn","loadBtn","sampleBtn"].forEach(c=>{const d=document.getElementById(c);d&&(d.dataset._wasHiddenByEdit=d.style.display==="none"?"1":"",d.style.display="none")});const s=document.querySelector(".smoothness-control");s&&(s.dataset._wasHiddenByEdit=s.style.display==="none"?"1":"",s.style.display="none"),w("Edit mode enabled: use gizmo arrows to move nodes, double-click to rename.");const a=document.getElementById("legendEditor");a&&(a.style.display=""),j()}else{const n=document.getElementById("nodeEditorHeader");n&&(n.style.display="none");const o=document.getElementById("editPanel");o&&(o.style.display="none",o.setAttribute("aria-hidden","true")),L&&(L.style.display="none"),y&&(y.style.display="none"),l=null,mt(),j(),fe(),["saveBtn","loadBtn","sampleBtn"].forEach(c=>{const d=document.getElementById(c);d&&(d.dataset._wasHiddenByEdit?delete d.dataset._wasHiddenByEdit:d.style.display="")});const s=document.querySelector(".smoothness-control");s&&(s.dataset._wasHiddenByEdit?delete s.dataset._wasHiddenByEdit:s.style.display=""),w("Edit mode disabled. Auto-rotate will resume after inactivity.");const a=document.getElementById("legendEditor");a&&(a.style.display="none")}}),e("applyEditBtn","click",()=>{document.getElementById("applyEditBtn")})}try{_e()}catch{}document.addEventListener("DOMContentLoaded",()=>{try{_e()}catch{}});document.addEventListener("click",e=>{if(!E||e.target.closest(".ui-container")||e.target.closest(".panel-box")||e.target.closest(".button"))return;const t=U.domElement.getBoundingClientRect();S.x=(e.clientX-t.left)/t.width*2-1,S.y=-((e.clientY-t.top)/t.height)*2+1,_.setFromCamera(S,I);const n=_.intersectObjects(q,!0);if(console.log("edit click",{mx:S.x.toFixed(2),my:S.y.toFixed(2),rectWidth:t.width,rectHeight:t.height,intersectsCount:n.length}),n&&n.length){let o=n[0].object;for(;o&&!q.includes(o);)o=o.parent;l=o||n[0].object.parent,l&&(je(),L.style.display="block",oe(),j(),ft(l))}else l=null,L&&(L.style.display="none"),j()});function Ke(e,t,n){const o=t.clone(),i=n.clone().normalize(),s=e.origin.clone(),a=e.direction.clone().normalize(),c=o.clone().sub(s),d=i.dot(i),u=i.dot(a),m=a.dot(a),p=i.dot(c),h=a.dot(c),g=d*m-u*u;let b=0;return Math.abs(g)>1e-6?b=(u*h-m*p)/g:b=0,o.add(i.multiplyScalar(b))}document.addEventListener("mousedown",e=>{if(!E||e.button!==0)return;const t=U.domElement.getBoundingClientRect();if(S.x=(e.clientX-t.left)/t.width*2-1,S.y=-((e.clientY-t.top)/t.height)*2+1,_.setFromCamera(S,I),v&&v.visible){const n=_.intersectObjects(v.children,!0);if(n&&n.length){let i=n[0].object;for(;i&&!i.userData.axis;)i=i.parent;if(i&&i.userData&&i.userData.axis){D=i.userData.axis,Ke(_.ray,v.position.clone(),new THREE.Vector3(D==="x"?1:0,D==="y"?1:0,D==="z"?1:0)),document.body.style.cursor="grabbing",Q=!1,ee=!1,e.preventDefault();return}}}});document.addEventListener("mousemove",e=>{if(!E||!D||!l)return;const t=U.domElement.getBoundingClientRect();S.x=(e.clientX-t.left)/t.width*2-1,S.y=-((e.clientY-t.top)/t.height)*2+1,_.setFromCamera(S,I);const n=new THREE.Vector3(D==="x"?1:0,D==="y"?1:0,D==="z"?1:0),o=Ke(_.ray,v.position.clone(),n);if(o){l.position.copy(o),oe(),we();const i=X(r.root,l.userData.id);i&&(i.pos=[l.position.x,l.position.y,l.position.z])}});document.addEventListener("mouseup",e=>{D&&(D=null,document.body.style.cursor="default",pt())});document.addEventListener("dblclick",e=>{!E||!l||Ue()});const R=document.getElementById("leftStick"),H=document.getElementById("rightStick"),Je=R&&R.querySelector(".stick-knob"),Qe=H&&H.querySelector(".stick-knob");function Ce(e,t,n){e&&(e.style.transform=`translate(${t}px, ${n}px)`)}function De(e){e&&(e.style.transition="transform 150ms ease-out",e.style.transform="translate(0, 0)",setTimeout(()=>e.style.transition="",160))}function et(e){fe();for(const t of Array.from(e.changedTouches)){const n=document.elementFromPoint(t.clientX,t.clientY);R&&(n===R||R.contains(n))?(f.leftTouchId=t.identifier,f.leftStart={x:t.clientX,y:t.clientY},f.leftPos={x:0,y:0}):H&&(n===H||H.contains(n))&&(f.rightTouchId=t.identifier,f.rightStart={x:t.clientX,y:t.clientY},f.rightPos={x:0,y:0})}}function tt(e){for(const t of Array.from(e.changedTouches))if(t.identifier===f.leftTouchId){const n=t.clientX-f.leftStart.x,o=t.clientY-f.leftStart.y,i=Math.hypot(n,o)||1,s=n/i*Math.min(i,f.maxRadius),a=o/i*Math.min(i,f.maxRadius);f.leftPos={x:s,y:a},Ce(Je,s,a)}else if(t.identifier===f.rightTouchId){const n=t.clientX-f.rightStart.x,o=t.clientY-f.rightStart.y;ue-=n*.008,V+=o*.12,V=Math.max(-20,Math.min(35,V)),f.rightStart={x:t.clientX,y:t.clientY},Ce(Qe,n*.6,o*.6)}}function xe(e){for(const t of Array.from(e.changedTouches))t.identifier===f.leftTouchId&&(f.leftTouchId=null,f.leftStart=null,f.leftPos={x:0,y:0},De(Je)),t.identifier===f.rightTouchId&&(f.rightTouchId=null,f.rightStart=null,De(Qe))}let J=null;function nt(e,t){const n=e.clientX-t.clientX,o=e.clientY-t.clientY;return Math.hypot(n,o)}function ht(e){if(e.touches.length===2){const t=nt(e.touches[0],e.touches[1]);J==null&&(J=t);const n=t-J;Z-=n*.03,Z=Math.max(15,Math.min(100,Z)),J=t}}function yt(e){e.touches.length<2&&(J=null)}R&&R.addEventListener("touchstart",et,{passive:!0});R&&R.addEventListener("touchmove",tt,{passive:!1});R&&R.addEventListener("touchend",xe,{passive:!0});H&&H.addEventListener("touchstart",et,{passive:!0});H&&H.addEventListener("touchmove",tt,{passive:!1});H&&H.addEventListener("touchend",xe,{passive:!0});document.addEventListener("touchstart",e=>{e.touches.length===2&&(J=nt(e.touches[0],e.touches[1])),fe()},{passive:!0});document.addEventListener("touchmove",e=>{e.touches.length===2&&ht(e),e.touches.length>=1&&e.preventDefault()},{passive:!1});document.addEventListener("touchend",e=>{xe(e),yt(e)},{passive:!0});const A=document.getElementById("btnUp"),N=document.getElementById("btnDown");function $(e,t){e&&e.classList.toggle("active",t)}A&&(A.addEventListener("touchstart",e=>{e.preventDefault(),f.upPressed=!0,$(A,!0)},{passive:!1}),A.addEventListener("touchend",e=>{e.preventDefault(),f.upPressed=!1,$(A,!1)},{passive:!0}),A.addEventListener("mousedown",()=>{f.upPressed=!0,$(A,!0)}),A.addEventListener("mouseup",()=>{f.upPressed=!1,$(A,!1)}));N&&(N.addEventListener("touchstart",e=>{e.preventDefault(),f.downPressed=!0,$(N,!0)},{passive:!1}),N.addEventListener("touchend",e=>{e.preventDefault(),f.downPressed=!1,$(N,!1)},{passive:!0}),N.addEventListener("mousedown",()=>{f.downPressed=!0,$(N,!0)}),N.addEventListener("mouseup",()=>{f.downPressed=!1,$(N,!1)}));document.addEventListener("contextmenu",e=>e.preventDefault());document.addEventListener("mousemove",e=>{if(Q){const t=e.clientX-G,n=e.clientY-Y;ue-=t*.008,V+=n*.15,V=Math.max(-20,Math.min(35,V)),G=e.clientX,Y=e.clientY}else if(ee){const t=e.clientX-G,n=e.clientY-Y,o=new THREE.Vector3(Math.cos(C),0,-Math.sin(C)),i=.08;z+=o.x*t*i,F+=o.z*t*i,K-=n*i,G=e.clientX,Y=e.clientY}});document.addEventListener("wheel",e=>{if(E)return;e.preventDefault();const t=e.deltaY*.03;Z+=t,Z=Math.max(15,Math.min(100,Z))},{passive:!1});function ot(){requestAnimationFrame(ot),Te++,W&&(ue+=.001),(Q||ee)&&fe();const e=window.smoothFactors||{drag:.25,zoom:.15,general:.12};C+=(ue-C)*e.drag,se+=(Z-se)*e.zoom,pe+=(V-pe)*e.drag,ae+=(z-ae)*e.general,le+=(K-le)*e.general,ce+=(F-ce)*e.general;const t=new THREE.Vector3(-Math.sin(C),0,-Math.cos(C)),n=new THREE.Vector3(Math.cos(C),0,-Math.sin(C)),o=.3;if(!E&&f.leftPos){const i=f.leftPos.x/f.maxRadius,s=-f.leftPos.y/f.maxRadius;Math.abs(i)>.12&&(z+=n.x*i*o*.8,F+=n.z*i*o*.8),Math.abs(s)>.12&&(z+=t.x*s*o*.8,F+=t.z*s*o*.8)}x.w&&(z+=t.x*o,F+=t.z*o),x.s&&(z-=t.x*o,F-=t.z*o),x.a&&(z-=n.x*o,F-=n.z*o),x.d&&(z+=n.x*o,F+=n.z*o),x.space&&(K+=o),x.shift&&(K-=o),f.upPressed&&(K+=o*.9),f.downPressed&&(K-=o*.9),I.position.x=ae+Math.sin(C)*se,I.position.z=ce+Math.cos(C)*se,I.position.y=le+pe,I.lookAt(ae,le,ce),q.forEach(i=>{i.userData.rotatingGroup&&(i.userData.rotatingGroup.rotation.y+=i.userData.rotationSpeed,i.userData.rotatingGroup.rotation.x+=i.userData.rotationSpeed*.5)}),de.forEach((i,s)=>{if(i.material.opacity=.3+Math.sin(Te*.05+s)*.2,i.userData&&(i.userData.startId||i.userData.endId)){const a=i.userData.startId?Be(i.userData.startId):null,c=i.userData.endId?Be(i.userData.endId):null;if(a||c){const d=i.geometry.attributes.position,u=d.array;a&&(u[0]=a.position.x,u[1]=a.position.y,u[2]=a.position.z),c&&(u[3]=c.position.x,u[4]=c.position.y,u[5]=c.position.z),d.needsUpdate=!0,i.geometry.computeBoundingSphere()}}}),ye.rotation.y+=3e-4,ye.rotation.x+=1e-4,l&&(oe(),we(),y&&y.style.display!=="none"&&Ue()),U.render(B,I)}ot();window.addEventListener("resize",()=>{I.aspect=window.innerWidth/window.innerHeight,I.updateProjectionMatrix(),U.setSize(window.innerWidth,window.innerHeight)});</script>
  <style rel="stylesheet" crossorigin>*{margin:0;padding:0;box-sizing:border-box}body{width:100%;height:100vh;background:linear-gradient(to bottom,#000,#2a1a3e,#000);font-family:Orbitron;overflow:hidden;cursor:default}#canvas{width:100%;height:100%;display:block}.ui-container{position:absolute;inset:0;pointer-events:none}.message-display{position:fixed;bottom:24px;left:50%;transform:translate(-50%);z-index:50;pointer-events:none}.message{font-family:monospace;color:#0ff;font-size:12px;background:#00000080;padding:8px 12px;border:1px solid #00ffff;margin:8px 0;animation:fadeOut 5s forwards;pointer-events:auto;cursor:pointer}@keyframes fadeOut{0%{opacity:1}80%{opacity:1}to{opacity:0}}.title{position:absolute;top:24px;left:50%;transform:translate(-50%);color:#f0f;font-size:24px;font-weight:700;animation:pulse 2s infinite;pointer-events:none}@keyframes pulse{0%,to{opacity:1}50%{opacity:.5}}.left-panel{position:absolute;top:24px;left:24px;color:#0ff;font-size:14px;pointer-events:auto;width:256px}.panel-box{background:#000000b3;padding:10px;border:1px solid #00ffff;width:100%}.right-panel .panel-box{overflow-x:hidden}.right-panel .panel-box{max-height:calc(100vh - 80px);overflow-y:auto;padding-right:8px}.legend{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #00ffff}.legend-title{font-size:12px;color:#0cf;margin-bottom:8px}.legend-entry{display:flex;align-items:center;gap:8px;font-size:12px;margin-bottom:4px}.legend-color{width:12px;height:12px;border:1px solid rgba(255,255,255,.2);border-radius:2px}.controls-text{font-size:12px;color:#0cf;line-height:1.6}.right-panel{position:absolute;top:18px;right:18px;color:#0ff;font-size:12px;pointer-events:all;width:260px}.button{width:100%;color:#0ff;font-size:12px;background:#00000080;padding:8px 12px;border:1px solid #00ffff;margin-bottom:8px;cursor:pointer;text-align:center;transition:all .2s}.button:hover{background:#0ff3;color:#fff;border-color:#0cf}.smoothness-control{margin-top:16px;padding-top:12px;border-top:1px solid #00ffff}.smoothness-label{font-size:12px;color:#0cf;margin-bottom:8px}.slider-container{display:flex;align-items:center;gap:8px;margin-bottom:8px}.slider-container span{font-size:12px;color:#fff}input[type=range]{flex:1;height:8px;background:#001a4d;border-radius:4px;appearance:none;-webkit-appearance:none;cursor:pointer}input[type=range]::-webkit-slider-thumb{appearance:none;-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#0ff;cursor:pointer;border:1px solid #ffffff}input[type=range]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:#0ff;cursor:pointer;border:1px solid #ffffff}.author-info{font-size:12px;color:#0ff;text-align:center;margin-top:4px}.author-info a{color:#fff;text-decoration:none}.author-info a:hover{text-decoration:underline;color:#fff}.author-info a:visited,.author-info a:active,.author-info a:focus{color:#fff;text-decoration:none}.legend-editor{margin-top:12px;border-top:1px dashed rgba(0,255,255,.12);padding-top:8px}.legend-editor,.edit-panel{max-height:40vh;overflow-y:auto}#legendList{display:flex;flex-direction:column;gap:2px}.legend-editor .legend-row input[type=text],.legend-editor .legend-row input[type=color],.legend-editor .legend-row button{min-width:0}.legend-editor input#newLegendName{flex:1 1 auto;min-width:0;width:100%;box-sizing:border-box;padding:4px;height:28px;font-size:12px}.legend-editor input#newLegendName::placeholder{color:#fff9}.legend-editor #newLegendSwatch{flex:0 0 28px;width:28px;height:28px;padding:0;border:1px solid rgba(255,255,255,.06);box-sizing:border-box;cursor:pointer}.legend-editor button#addLegendBtn{flex:0 0 60px;min-width:60px;height:28px;padding:0 8px;box-sizing:border-box}.legend-editor .legend-row{display:grid;grid-template-columns:1fr 28px 60px;gap:8px;align-items:center;margin-bottom:2px}.legend-editor .legend-row input[type=text]{width:100%;padding:4px;height:28px;box-sizing:border-box;background:#0009;border:1px solid #00ffff;color:#0ff;font-size:12px}.legend-editor .legend-row .legend-swatch{width:28px;height:28px;padding:0;border:1px solid rgba(255,255,255,.06);background:#000;box-sizing:border-box;cursor:pointer;align-self:center}.legend-editor .legend-row button{width:100%;height:28px;padding:0 8px;box-sizing:border-box;display:inline-flex;align-items:center;justify-content:center;line-height:28px;margin:0}.legend-editor .legend-row>*{box-sizing:border-box;vertical-align:middle}.hidden-input{display:none}.ui-toggle{position:absolute;bottom:24px;left:24px;color:#0ff;font-size:12px;background:#00000080;padding:8px 12px;border:1px solid #00ffff;pointer-events:auto;display:none}.ui-toggle.visible{display:block}.mobile-controls{position:absolute;inset:0 0 18px;pointer-events:none}.stick{width:120px;height:120px;border-radius:50%;background:#0006;border:2px solid rgba(0,255,255,.12);position:absolute;pointer-events:auto;touch-action:none;display:flex;align-items:center;justify-content:center}.stick-knob{width:44px;height:44px;border-radius:50%;background:#00ffffe6;transform:translate(0)}.left-stick{left:18px;bottom:18px}.right-stick{right:18px;bottom:18px}.action-buttons{position:absolute;right:18px;bottom:150px;display:flex;flex-direction:column;gap:8px;pointer-events:auto}.action-btn{width:56px;height:40px;border-radius:8px;background:#0009;color:#0ff;border:1px solid #00ffff;font-size:18px;display:inline-flex;align-items:center;justify-content:center;touch-action:manipulation}@media(min-width:900px){.mobile-controls{display:none}}@media(max-width:899px){.ui-container .left-panel,.ui-container .right-panel,.title{display:none}.mobile-controls{display:block}}@media(min-width:900px){.button#editBtn{display:block}.edit-overlay{position:absolute;inset:0;pointer-events:none}.selected-node-indicator{width:48px;height:48px;border:2px dashed rgba(255,255,0,.9);border-radius:6px;position:absolute;transform:translate(-50%,-50%);pointer-events:none;z-index:80}.edit-panel{margin-top:6px;background:transparent;padding:4px 0 0;border:none;display:block}.edit-row{display:flex;gap:6px;align-items:center;margin:2px 0}.edit-row label{width:48px;color:#0ff;font-size:11px}.edit-row input[type=text],.edit-row input[type=number],.edit-row input[type=color]{flex:1;padding:4px;background:#0009;border:1px solid #00ffff;color:#0ff;font-size:12px}.edit-actions{display:flex;gap:6px;margin-top:8px;margin-bottom:0}.edit-panel .button,.edit-panel .button.small{margin-bottom:0}.button.small{padding:4px 6px;font-size:11px}.button.danger{border-color:#f55;color:#f88}}.mobile-menu{position:absolute;left:50%;transform:translate(-50%);bottom:18px;display:flex;gap:8px;pointer-events:auto;z-index:60}.mobile-action{z-index:70}.mobile-action{width:48px;height:48px;border-radius:10px;background:#000000b3;color:#0ff;border:1px solid #00ffff;font-size:18px;display:inline-flex;align-items:center;justify-content:center;touch-action:manipulation}@media(min-width:900px){.mobile-menu{display:none}}</style>
</head>
<body>
	<div id="canvas"></div>
	<div class="ui-container">
		<div class="title" id="title">ARCHITECTURE VISUALIZATION</div>
		<div class="left-panel" id="leftPanel">
			<div class="panel-box">
				<div class="legend" id="legendContainer" style="display: none;">
					<div class="legend-title">LEGEND:</div>
					<div id="legendItems"></div>
				</div>
				<div class="controls-text">
					ORBIT MODE<br>
					LEFT DRAG - ROTATE VIEW<br>
					RIGHT/MIDDLE DRAG - PAN<br>
					SCROLL - ZOOM<br>
					WASD - MOVE CAMERA<br>
					SPACE/SHIFT - UP/DOWN<br>
					AUTO-ROTATES AFTER 3s
					<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #00ffff;">
						<span style="color: #ffff00;">U</span> - TOGGLE UI<br>
						<span style="color: #ffff00;">Q</span> - TOGGLE CURSOR
					</div>
				</div>
			</div>
		</div>
		<div class="right-panel" id="rightPanel">
			<div class="panel-box">
				<button class="button" id="saveBtn">💾 SAVE</button>
				<button class="button" id="loadBtn">📁 LOAD</button>
				<button class="button" id="sampleBtn">📋 LOAD SAMPLE</button>
				<button class="button" id="editBtn">✏️ EDIT</button>
				<div class="smoothness-control">
					<div class="smoothness-label">SMOOTHNESS:</div>
					<div class="slider-container">
						<span>MIN</span>
						<input type="range" id="smoothnessSlider" min="0.05" max="0.5" step="0.05" value="0.15">
						<span>MAX</span>
					</div>
					<div class="author-info">
						© <a href="https://github.com/cziter15" target="_blank">K. STREHLAU</a>
					</div>
				</div>

				<!-- Legend editor (always visible) -->
				<div class="legend-editor" id="legendEditor" style="margin-top:12px;">
					<div style="margin-bottom:8px;">
						<div class="legend-title" style="font-size:12px;color:#00ccff;">LEGEND EDITOR</div>
					</div>
					<div id="legendList"></div>
					<div class="legend-row" style="margin-top:8px;">
						<input type="text" id="newLegendName" placeholder="Name" />
						<div id="newLegendSwatch" style="width:28px;height:28px;border:1px solid #00ffff;background:#00ffff;cursor:pointer;"></div>
						<button class="button small" id="addLegendBtn">ADD</button>
					</div>
				</div>
				<!-- Edit panel (desktop only) -->
				<div style="border-top:1px dashed rgba(0,255,255,0.12);margin-top:8px;padding-top:4px;">
					<div id="nodeEditorHeader" style="font-size:12px;color:#00ccff;margin:4px 0 6px 0;">NODE EDITOR</div>
				</div>
				<div class="edit-panel" id="editPanel" aria-hidden="true" style="display:none;">
					<div id="editContent">
						<div class="edit-row"><label>Name</label><input type="text" id="editName"></div>
						<!-- Color removed: node color is derived from legend category -->
						<!-- EDIT LEGEND button removed from node editor (legend editor has its own controls) -->
						<div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
							<select id="assignLegendSelect" style="flex:1;padding:6px;background:rgba(0,0,0,0.6);border:1px solid #00ffff;color:#00ffff;"></select>
						</div>
						<div class="edit-row"><label>Scale</label><input type="number" id="editScale" step="0.1" min="0.1"></div>
						<div class="edit-row"><label>Pos X</label><input type="number" id="editPosX" step="0.1"></div>
						<div class="edit-row"><label>Pos Y</label><input type="number" id="editPosY" step="0.1"></div>
						<div class="edit-row"><label>Pos Z</label><input type="number" id="editPosZ" step="0.1"></div>
						<div class="edit-actions">
							<button class="button small" id="addChildBtn">+ CHILD</button>
							<button class="button small danger" id="deleteNodeBtn">DELETE</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="message-display" id="messageDisplay"></div>
		<div class="ui-toggle" id="uiToggle">Press U to show UI</div>
	</div>
	<!-- Mobile controls -->
	<div id="mobileControls" class="mobile-controls" aria-hidden="true">
		<div id="leftStick" class="stick left-stick" aria-label="move joystick">
			<div class="stick-knob"></div>
		</div>
		<div id="rightStick" class="stick right-stick" aria-label="look joystick">
			<div class="stick-knob"></div>
		</div>
		<div class="action-buttons">
			<button id="btnUp" class="action-btn">▲</button>
			<button id="btnDown" class="action-btn">▼</button>
		</div>
	</div>

	<!-- Mobile menu: quick actions for small screens -->
	<div class="mobile-menu" id="mobileMenu">
		<button id="mobileSaveBtn" class="mobile-action">💾</button>
		<button id="mobileLoadBtn" class="mobile-action">📁</button>
		<button id="mobileSampleBtn" class="mobile-action">📋</button>
	</div>
	<input type="file" id="xmlFileInput" class="hidden-input" accept=".xml">
</body>
</html>
